import{d as Xe,W as Fe,c,r as n,a5 as Pe,a6 as Ge,Q as De,o as He,N as Ve,a as i,v as de,b as t,e as B,a3 as qe,B as W,t as p,u as je,A as Je,F as K,p as f,w as Ke,T as Qe,h as ve,q as L,s as Ze,f as u,n as me,_ as Oe}from"./index-C_z2IO5A.js";import{h as Ye}from"./home-icon-CTPXHMtR.js";import{b as et}from"./back-icon-xKqy7r3s.js";const tt="/TaiyakiEduGames/assets/increasing-beeps-CgtrJ9xB.mp3",at={class:"topbar"},st={class:"left"},nt=["src"],lt={class:"title"},ot={class:"right"},it=["src"],ut={key:0,class:"menu-wrap"},rt={class:"menu-card"},ct={key:0,class:"warning"},dt={class:"menu-section"},vt={class:"seg"},mt={class:"menu-section"},pt={class:"seg"},ft=["disabled"],gt={key:0,class:"muted need-more"},ht={key:1,class:"play-area"},yt=["data-mult"],wt={class:"stage"},bt=["onClick"],kt={key:0,class:"label"},_t=["src"],xt={key:2,class:"image-text-wrap"},Ct=["src"],St={class:"label below"},Mt={class:"status","aria-live":"polite"},Tt={class:"status-chip"},Rt={class:"score"},At={class:"round"},Bt={key:2,class:"results"},Wt={class:"table-wrap"},Lt={class:"results-table"},$t=1,Et=Xe({__name:"SoundMatcher",setup(It){const Q=je(),pe=Je(),h=Fe(),fe=c(()=>h.deckName||"Listening"),$=c(()=>h.cards||[]),ge=c(()=>h.startMode??"easy"),Z=c(()=>h.audioLocale||"en-US"),he=c(()=>typeof h.ttsRate=="number"?h.ttsRate:1),y=n("menu"),d=n("text"),w=n(ge.value),X=c(()=>$.value.length<6),ye=c(()=>$.value.length<3),we=n(!0),E=c(()=>w.value==="easy"?3:6),I=n([]),r=n(null),F=n([]),b=n(0),k=n(0),_=n(0),O=n(0),P=n(!1),x=n(null),U=n(0),C=n(null),S=n(null),G=n(!1),D=n(!1),M=c(()=>ne(1+Math.floor(_.value/5),1,5)),z=n(!1),T=n([]),H=n([]),be=c(()=>T.value),Y=n(new Map),ee=new Map,te=new Audio(Pe),ae=new Audio(Ge),se=new Audio(tt),m=n(null);async function ke(a,e="en-US"){if(!a.length)return;const{data:s,error:l}=await Ze.from("flashcard_audio").select("card_id, audio_url, audio_mime, source, locale, speed, status").in("card_id",a).eq("status","ready");if(l){console.warn("[sound-matcher] audio fetch error",l);return}const o=v=>{let g=3;v.locale===e&&v.speed==="normal"?g=1:v.locale===e?g=2:String(v.locale||"").startsWith("en")&&(g=2.5);const J=v.source==="human"?-.25:0;return g+J},N={};for(const v of s||[])(N[v.card_id]||=[]).push(v);const A=new Map;for(const v of a){const g=(N[v]||[]).sort((J,Ne)=>o(J)-o(Ne));g[0]&&A.set(v,{url:g[0].audio_url,mime:g[0].audio_mime})}Y.value=A}function V(a){for(let e=a.length-1;e>0;e--){const s=Math.floor(Math.random()*(e+1));[a[e],a[s]]=[a[s],a[e]]}return a}function _e(a,e,s){const l=s?a.filter(o=>o.id!==s):[...a];return V(l),l.slice(0,e)}function ne(a,e,s){return Math.max(e,Math.min(s,a))}function xe(a,e="en-US"){return a.find(s=>s.lang===e)||a.find(s=>s.lang?.startsWith("en"))||a[0]}async function le(a){const e=Y.value.get(a.id);if(e?.url){let o=ee.get(a.id);o?o.currentTime=0:(o=new Audio(e.url),o.preload="auto",ee.set(a.id,o));try{await o.play();return}catch{}}const s=new SpeechSynthesisUtterance(a.english??""),l=speechSynthesis.getVoices();s.voice=xe(l,Z.value),s.rate=he.value,speechSynthesis.cancel(),speechSynthesis.speak(s)}function Ce(){r.value&&le(r.value)}function Se(a){const e=_e($.value,E.value-1,a.id);F.value=V([...e,a])}async function oe(){if(P.value=!1,x.value=null,C.value=null,S.value=null,r.value=I.value[b.value]??null,!r.value){ue();return}Se(r.value),await L(),O.value=performance.now(),le(r.value)}function ie(){G.value=!0,U.value+=1}async function Me(){G.value&&(G.value=!1,b.value+=1,await oe())}function Te(){}function Re(a){if(P.value||!r.value)return;P.value=!0,C.value=a.id;const e=performance.now()-O.value,s=a.id===r.value.id;if(S.value=s,s){try{te.currentTime=0,te.play()}catch{}const l=4,o=ne(2-Math.floor(e/3e3*2),0,2),N=M.value;_.value+=1;const A=M.value,v=Math.round((l+o)*A);if(k.value+=v,A>N){try{se.currentTime=0,se.play()}catch{}z.value=!1,requestAnimationFrame(()=>{z.value=!0,setTimeout(()=>z.value=!1,600)})}T.value.push({id:r.value.id,english:r.value.english,correct:!0,responseMs:Math.round(e)}),setTimeout(()=>{ie()},420)}else{try{ae.currentTime=0,ae.play()}catch{}_.value=0,x.value=r.value.id,T.value.push({id:r.value.id,english:r.value.english,correct:!1,responseMs:Math.round(e)}),setTimeout(()=>{ie()},480)}}const q=n({listening:0,reading:0});function ue(){const a=Math.round(k.value*$t);if(d.value==="text"){const e=Math.round(a*.7);q.value={listening:e,reading:a-e}}else q.value={listening:a,reading:0};y.value="results",Ae()}async function Ae(){H.value=[];const a=be.value.slice();let e=0;const s=window.setInterval(()=>{if(e>=a.length){clearInterval(s);return}H.value.push(a[e++])},180);await L(),window.setTimeout(()=>{const{listening:l,reading:o}=q.value;m.value?.open&&m.value.open(),l>0&&m.value?.addListeningXp?m.value.addListeningXp(l):l>0&&m.value?.addWritingXp&&m.value.addWritingXp(l),o>0&&m.value?.addReadingXp?m.value.addReadingXp(o):o>0&&m.value?.addWritingXp&&m.value.addWritingXp(o)},450)}function Be(){I.value=V($.value.slice()),ke(I.value.map(a=>a.id),Z.value).finally(async()=>{we.value=!1,D.value=!1,await L(),"speechSynthesis"in window&&(window.speechSynthesis.onvoiceschanged=()=>{}),b.value=0,T.value=[],k.value=0,_.value=0,y.value="playing",U.value=0,await L(),oe(),await L(),D.value=!0})}function We(){ue()}function re(){y.value="menu",T.value=[],k.value=0,_.value=0,b.value=0,U.value=0,r.value=null,F.value=[],x.value=null,C.value=null,S.value=null}function Le(){Q.back()}const j=n("md");function $e(a){return a>=1024?"lg":a>=600?"md":"sm"}const Ee={sm:{gap:9,text:{w:104,h:60},image:{w:120,h:128},imageText:{w:120,h:148},paddings:{lr:12,tb:16}},md:{gap:12,text:{w:140,h:84},image:{w:168,h:184},imageText:{w:168,h:204},paddings:{lr:24,tb:28}},lg:{gap:16,text:{w:200,h:120},image:{w:220,h:236},imageText:{w:220,h:260},paddings:{lr:40,tb:40}}},Ie=c(()=>d.value),ce=c(()=>{const a=Ee[j.value];return{...a[Ie.value],gap:a.gap}}),Ue=c(()=>{const{w:a,h:e,gap:s}=ce.value,l=E.value===3?"1":"2";return{display:"grid",gap:`${s}px`,gridTemplateColumns:`repeat(3, ${a}px)`,gridTemplateRows:l==="1"?`${e}px`:`repeat(2, ${e}px)`,alignContent:"center",justifyContent:"center",margin:"0 auto",width:"100%",maxWidth:"100%"}}),ze=c(()=>{const{w:a,h:e}=ce.value;return{width:`${a}px`,height:`${e}px`}});function R(){j.value=$e(window.innerWidth)}return De([E,()=>d.value],()=>{}),He(()=>{R(),window.addEventListener("resize",R,{passive:!0}),window.addEventListener("orientationchange",R,{passive:!0})}),Ve(()=>{window.removeEventListener("resize",R),window.removeEventListener("orientationchange",R)}),(a,e)=>(u(),i("section",{class:f(["sound-matcher",["tier-"+j.value]])},[de(qe,{ref_key:"levelsRef",ref:m,overlay:!0},null,512),t("header",at,[t("div",st,[t("button",{class:"icon-btn",onClick:Le,"aria-label":"Back"},[t("img",{src:W(Ye),alt:""},null,8,nt)]),t("h2",lt,p(fe.value),1)]),t("div",ot,[y.value==="playing"?(u(),i("button",{key:0,class:"flat-btn danger",onClick:We,"aria-label":"End Game"}," End Game ")):B("",!0),t("button",{class:"icon-btn home",onClick:re,"aria-label":"Home"},[t("img",{src:W(et),alt:""},null,8,it)])])]),y.value==="menu"?(u(),i("div",ut,[t("div",rt,[e[10]||(e[10]=t("h3",{class:"menu-title"},"Sound Matcher",-1)),ye.value?(u(),i("div",ct,[e[6]||(e[6]=t("p",null,[t("strong",null,"Please choose more cards.")],-1)),e[7]||(e[7]=t("p",{class:"jp"},"ã‚‚ã£ã¨ã‚«ãƒ¼ãƒ‰ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚",-1)),t("button",{class:"flat-btn back-to-deck",onClick:e[0]||(e[0]=s=>W(Q).push({name:"deck",params:{id:W(h).deckId||W(pe).params.deckId}}))}," Back to Deck / ãƒ‡ãƒƒã‚­ã¸æˆ»ã‚‹ ")])):(u(),i(K,{key:1},[t("div",dt,[e[8]||(e[8]=t("p",{class:"label"},"Mode",-1)),t("div",vt,[t("button",{class:f(["seg-btn",{active:d.value==="text"}]),onClick:e[1]||(e[1]=s=>d.value="text")},"Words",2),t("button",{class:f(["seg-btn",{active:d.value==="image"}]),onClick:e[2]||(e[2]=s=>d.value="image")},"Images",2),t("button",{class:f(["seg-btn",{active:d.value==="imageText"}]),onClick:e[3]||(e[3]=s=>d.value="imageText")},"Images + Words",2)])]),t("div",mt,[e[9]||(e[9]=t("p",{class:"label"},"Difficulty",-1)),t("div",pt,[t("button",{class:f(["seg-btn",{active:w.value==="easy"}]),onClick:e[4]||(e[4]=s=>w.value="easy")}," Easy (3) ",2),t("button",{class:f(["seg-btn",{active:w.value==="hard"}]),disabled:X.value,title:"Need at least 6 cards",onClick:e[5]||(e[5]=s=>!X.value&&(w.value="hard"))}," Hard (6) ",10,ft)]),X.value?(u(),i("p",gt,"Need at least 6 cards for Hard.")):B("",!0)]),t("button",{class:"play-btn",onClick:Be},"Play â–¶")],64))])])):y.value==="playing"?(u(),i("div",ht,[t("div",{class:"controls"},[t("button",{class:"replay-btn",onClick:Ce,title:"Hear again","aria-label":"Replay"},"ðŸ”Š")]),M.value>=2?(u(),i("div",{key:0,class:f(["streak-big",{bump:z.value}]),"data-mult":M.value}," x"+p(M.value),11,yt)):B("",!0),t("div",wt,[de(Qe,{name:"board",mode:"out-in",onAfterLeave:Me,onAfterEnter:Te},{default:Ke(()=>[(u(),i("div",{class:"round-wrap",key:U.value},[D.value?(u(),i("div",{key:0,class:f(["board",[`choices-${E.value}`,d.value==="image"?"image-mode":d.value==="imageText"?"image-text-mode":"text-mode"]]),style:me(Ue.value)},[(u(!0),i(K,null,ve(F.value,s=>(u(),i("button",{key:s.id,class:f(["choice card",{reveal:x.value&&s.id===x.value,correct:C.value===s.id&&S.value===!0,wrong:C.value===s.id&&S.value===!1}]),style:me(ze.value),onClick:l=>Re(s)},[d.value==="text"?(u(),i("span",kt,p((s.english||"").trim()),1)):d.value==="image"?(u(),i("img",{key:1,class:"img",src:s.image_url,alt:"",draggable:"false"},null,8,_t)):(u(),i("div",xt,[t("img",{class:"img",src:s.image_url,alt:"",draggable:"false"},null,8,Ct),t("span",St,p((s.english||"").trim()),1)]))],14,bt))),128))],6)):B("",!0)]))]),_:1})]),t("footer",Mt,[t("div",Tt,[t("div",Rt,"Score: "+p(k.value),1),e[11]||(e[11]=t("div",{class:"dot","aria-hidden":"true"},"â€¢",-1)),t("div",At,p(b.value+1)+" / "+p(I.value.length),1)])])])):y.value==="results"?(u(),i("div",Bt,[e[13]||(e[13]=t("h3",{class:"results-title"},"Results",-1)),t("div",Wt,[t("table",Lt,[e[12]||(e[12]=t("thead",null,[t("tr",null,[t("th",null,"#"),t("th",null,"Word"),t("th",null,"Correct"),t("th",null,"Response (s)")])],-1)),t("tbody",null,[(u(!0),i(K,null,ve(H.value,(s,l)=>(u(),i("tr",{key:s.id+"-"+l},[t("td",null,p(l+1),1),t("td",null,p(s.english),1),t("td",null,[t("span",{class:f(["badge",s.correct?"ok":"no"])},p(s.correct?"âœ“":"âœ—"),3)]),t("td",null,p((s.responseMs/1e3).toFixed(2)),1)]))),128))])])]),t("button",{class:"flat-btn",onClick:re},"Home")])):B("",!0)],2))}}),Xt=Oe(Et,[["__scopeId","data-v-3221bb81"]]);export{Xt as default};
