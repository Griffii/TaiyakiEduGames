import{i as N,r as d,c as n,m as C,j as E,w as M,o as O,a as r,d as i,t as _,h as U,E as D,F as G,e as V,s as y,b as o,_ as T}from"./index-CRwM6Ms3.js";const j={class:"page activity-runner"},H={class:"head title-head"},Q={class:"title"},J={class:"content runner-content"},K=["src"],P={key:1,class:"empty"},X={class:"muted"},Y={key:0,class:"tags"},Z={class:"chips"},ee=N({__name:"ActivityRunner",setup(ae){const c=C(),m=d(null),w=d(null),u=n(()=>c.params.slug),k=n(()=>c.params.id),S=/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i,l=(c.meta??{}).activity??void 0,s=d(null),p=d(!1),v=d(null);async function b(){if(v.value=null,s.value=null,!y)return;const a=k.value||u.value||l?.slug;if(a){p.value=!0;try{let e;if(S.test(a)?e=await y.from("activities").select("id,slug,name,type,url_path,external_url,icon_url,thumbnail_url,tags,launch_params,status,archived_at").eq("id",a).maybeSingle():e=await y.from("activities").select("id,slug,name,type,url_path,external_url,icon_url,thumbnail_url,tags,launch_params,status,archived_at").eq("slug",a).maybeSingle(),e.error)throw e.error;s.value=e.data??null,s.value||(v.value="Activity not found.")}catch(e){v.value=e?.message||"Failed to load activity."}finally{p.value=!1}}}E(b),M([u,k],()=>b());function R(){const a=c.query?.tags;return a?Array.isArray(a)?a.flatMap(e=>String(e).split(",")).map(e=>e.trim()).filter(Boolean):String(a).split(",").map(e=>e.trim()).filter(Boolean):[]}const q=n(()=>s.value?.name??l?.name??l?.title??(u.value?u.value.replace(/-/g," "):"Activity")),x=n(()=>(s.value?.tags??l?.tags??R()??[]).filter(Boolean));function F(a){if(!a)return"";let e=String(a).trim();if(!e)return"";if(/^[a-z][a-z0-9+\-.]*:\/\//i.test(e)||/^[a-z][a-z0-9+\-.]*:/i.test(e))return e;if(e.startsWith("//"))return(window.location?.protocol||"https:")+e;/^[\w.-]+\.[a-z]{2,}([/:?#]|$)/i.test(e)&&(e="https://"+e);try{const t=new URL(e,window.location.origin),I=t.pathname.split("/").pop()||"";return!/\.[a-z0-9]+$/i.test(I)&&!t.search&&!t.hash&&!t.pathname.endsWith("/")&&(t.pathname+="/"),t.toString()}catch{return e}}const g=n(()=>s.value?.slug||u.value||l?.slug||"activity"),B=n(()=>{const a=s.value?.external_url??l?.external_url??c.query.url;if(a)return a;const e="/TaiyakiEduGames/".replace(/\/+$/,""),t=g.value||"activity";return`${e}/godot_games/${t}/index.html`}),h=n(()=>F(B.value));function z(a){try{return new URL(a).origin}catch{return null}}const W=new Set([typeof window<"u"?window.location.origin:""]),f=n(()=>{const a=z(h.value);return a&&W.has(a)?a:null});function $(){if(!f.value)return;const a={version:"1.0.0",activity_id:s.value?.id||g.value,slug:s.value?.slug||g.value};m.value?.contentWindow?.postMessage({type:"parent:init",payload:a},f.value)}function L(a){if(!f.value||a.origin!==f.value)return;const{type:e,payload:t}=a.data||{};e==="request:fullscreen"&&A(),e==="xp:award"&&console.info("[ActivityRunner] xp:award",t),e==="track:event"&&console.info("[ActivityRunner] track:event",t)}function A(){const a=m.value||w.value||document.documentElement,e=a.requestFullscreen||a.webkitRequestFullscreen||a.msRequestFullscreen;e&&e.call(a)}return E(()=>window.addEventListener("message",L)),O(()=>window.removeEventListener("message",L)),(a,e)=>(o(),r("div",j,[i("header",H,[i("h1",Q,_(q.value),1)]),i("main",J,[i("div",{class:"frame-wrap",ref_key:"frameWrap",ref:w},[h.value?(o(),r("iframe",{key:0,ref_key:"frameEl",ref:m,src:h.value,title:"",allow:"fullscreen; autoplay; gamepad",allowfullscreen:"",sandbox:"allow-scripts allow-same-origin allow-pointer-lock allow-forms allow-popups",onLoad:$},null,40,K)):(o(),r("div",P,[i("p",X,_(p.value?"Loading activityâ€¦":v.value||"No external URL configured for this activity."),1)]))],512),i("div",{class:"under-actions"},[i("button",{class:"btn primary",onClick:A}," Go Fullscreen ")]),x.value.length?(o(),r("section",Y,[i("div",Z,[(o(!0),r(G,null,V(x.value,t=>(o(),r("span",{key:t,class:"chip"},"# "+_(t),1))),128))])])):U("",!0),e[0]||(e[0]=D('<section class="achievements" data-v-d48585ea><h2 class="section-title" data-v-d48585ea>Achievements</h2><div class="badges" data-v-d48585ea><div class="badge locked" data-v-d48585ea><div class="icon" aria-hidden="true" data-v-d48585ea>ğŸ†</div><div class="label" data-v-d48585ea>Locked</div></div><div class="badge locked" data-v-d48585ea><div class="icon" aria-hidden="true" data-v-d48585ea>â­</div><div class="label" data-v-d48585ea>Locked</div></div><div class="badge locked" data-v-d48585ea><div class="icon" aria-hidden="true" data-v-d48585ea>ğŸ¯</div><div class="label" data-v-d48585ea>Locked</div></div><div class="badge locked" data-v-d48585ea><div class="icon" aria-hidden="true" data-v-d48585ea>â±ï¸</div><div class="label" data-v-d48585ea>Locked</div></div></div><small class="muted note" data-v-d48585ea>Achievement tracking coming soon.</small></section>',1))])]))}}),ie=T(ee,[["__scopeId","data-v-d48585ea"]]);export{ie as default};
