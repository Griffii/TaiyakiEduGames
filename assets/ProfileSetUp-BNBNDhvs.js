import{d as M,A as U,r as c,c as x,o as E,s as d,u as C,w as F,b as n,e,j as P,f as m,p as B,G as D,H as I,t as V,D as z,S as L,h as o,_ as q}from"./index-BKV_-VsF.js";const G={class:"setup-view"},R={class:"container"},X={class:"card","aria-labelledby":"setup-title"},Y={key:0,class:"loading-row"},$={class:"row"},j=["aria-invalid"],H={key:0,class:"err"},K={class:"avatar"},T=["src"],W={class:"avatar-actions"},J={key:1,class:"err"},O={class:"actions"},Q=["disabled"],Z={key:0},aa={key:1},ea=60,sa=M({__name:"ProfileSetUp",setup(ta){const l=U(),b=C(),h=c(!0),p=c(!1),u=c(null),w=/^[\p{L}\p{N}\p{M} _'\-\.ãƒ»â€™]+$/u;function f(t){return(t??"").normalize("NFKC").replace(/[\u0000-\u001F\u007F-\u009F]/g,"").replace(/[\u200B-\u200D\uFEFF]/g,"").replace(/[^\p{L}\p{N}\p{M} _'\-\.ãƒ»â€™]+/gu,"").slice(0,ea).trim()}const r=c(""),_=x(()=>r.value.length>0&&w.test(r.value));function N(t){const a=t.target,s=f(a.value);a.value!==s&&(a.value=s),r.value=s}const g=c(!1),i=c("");function S(){i.value=""}async function y(t){if(!t){i.value="";return}const a=d.storage.from("public-assets").getPublicUrl(t);if(i.value=a?.data?.publicUrl||"",!i.value){const{data:s}=await d.storage.from("public-assets").createSignedUrl(t,3600);i.value=s?.signedUrl??""}}function k(){g.value=!1,y(l.profile?.avatar_url)}E(async()=>{try{const{data:t}=await d.auth.getSession();if(!t.session?.user){b.replace("/login");return}l.profile||await l.loadProfile?.();const s=l.profile;r.value=f(s?.display_name??s?.name??l.displayName??""),await y(s?.avatar_url)}catch{}finally{h.value=!1}}),F(()=>l.profile?.avatar_url,t=>y(t));async function A(){if(u.value=null,!_.value){u.value="Please enter a valid name.";return}const{data:t}=await d.auth.getSession(),a=t.session?.user?.id;if(!a){u.value="Not signed in.";return}const s=f(r.value);p.value=!0;try{const{error:v}=await d.from("profiles").update({display_name:s,name:s,avatar_url:l.profile?.avatar_url??null,setup_complete:!0}).eq("id",a);if(v)throw v;await l.loadProfile?.(),b.replace("/dashboard")}catch(v){u.value=v?.message??"Could not save your setup."}finally{p.value=!1}}return(t,a)=>(o(),n("div",G,[e("div",R,[e("section",X,[a[6]||(a[6]=e("header",{class:"head"},[e("h1",{id:"setup-title",class:"title"},"Welcome ðŸŽ‰"),e("p",{class:"sub"},"Finish setting up your account.")],-1)),h.value?(o(),n("div",Y,[...a[2]||(a[2]=[e("span",{class:"spinner","aria-hidden":"true"},null,-1),e("span",{class:"loading-text"},"Loadingâ€¦",-1)])])):(o(),n("form",{key:1,class:"form",onSubmit:B(A,["prevent"])},[a[4]||(a[4]=e("label",{class:"lab",for:"name"},"Display Name",-1)),e("div",$,[D(e("input",{id:"name","onUpdate:modelValue":a[0]||(a[0]=s=>r.value=s),onInput:N,"aria-invalid":_.value?"false":"true",type:"text",placeholder:"Your display name",class:"inp",autocomplete:"name",inputmode:"text",autocapitalize:"words",maxlength:"60",required:""},null,40,j),[[I,r.value]])]),_.value?m("",!0):(o(),n("small",H," Use letters, numbers, spaces, _ - . ' â€™ ãƒ» only (max 60). ")),a[5]||(a[5]=e("label",{class:"lab"},"Avatar",-1)),e("div",K,[i.value?(o(),n("img",{key:0,src:i.value,alt:"Avatar preview",class:"avatar-img",onError:S},null,40,T)):m("",!0),e("div",W,[e("button",{class:"choose-pill",type:"button",onClick:a[1]||(a[1]=s=>g.value=!0)}," Choose avatar "),a[3]||(a[3]=e("small",{class:"muted"},"You can change this later.",-1))])]),u.value?(o(),n("p",J,V(u.value),1)):m("",!0),e("div",O,[e("button",{class:"btn pri",type:"submit",disabled:p.value},[p.value?(o(),n("span",Z,"Savingâ€¦")):(o(),n("span",aa,"Save & continue"))],8,Q)])],32))])]),g.value?(o(),P(L,{key:0,"current-key":z(l).profile?.avatar_url||void 0,onClose:k},null,8,["current-key"])):m("",!0)]))}}),oa=q(sa,[["__scopeId","data-v-9250a90d"]]);export{oa as default};
