import{i as Pe,l as Re,r as n,c as x,w as Xe,j as $e,m as Ue,s as de,a as o,d as a,h as C,k as O,t as v,n as We,f as S,v as ve,$ as pe,F as M,e as X,G as fe,g as he,a0 as De,a1 as Ge,a2 as Ne,u as Fe,L as qe,b as r,_ as He}from"./index-BiuPMolj.js";import{p as Ke}from"./fanfare-CkYegsGg.js";const Ve={class:"sb-head"},Ze={class:"right"},Oe={class:"stat"},Je={class:"v"},Qe={class:"stat"},Ye={class:"v"},et=["aria-expanded"],tt={class:"sb-main"},st={key:0,class:"muted"},at={key:1,class:"error"},lt=["aria-valuenow"],nt={class:"multiplier-row"},ot={key:0,class:"start-screen"},rt={class:"mode-select"},ut=["aria-pressed"],it=["aria-pressed"],ct={class:"image-wrap"},dt={key:0,class:"jp-title"},vt={class:"img-cell"},pt=["src","alt"],ft={class:"word-wrap"},ht={key:0,class:"word-group"},mt={class:"user"},gt={key:0,class:"hint"},yt={key:1,class:"space-gap","aria-hidden":"true"},_t={class:"controls"},kt=["disabled"],bt=["disabled"],wt=["disabled"],xt={class:"mini"},Ct={key:2,class:"summary"},St={class:"results"},Lt={class:"tc"},Tt={class:"tc"},Bt={class:"tc"},Mt={class:"tc"},It={class:"tc"},jt={class:"settings-panel",role:"dialog","aria-modal":"true"},Et={class:"row"},zt={class:"seg"},At=Pe({__name:"SpellingBlitz",props:{cards:{},deckId:{},startMode:{}},setup(me){const I=me,ge=Fe(),J=Ue();Re();const j=n(null),$=n(!0),U=n(null),W=n([]),g=n([]),_=n(0),u=n(I.startMode??"easy"),k=n(!1),D=n(!1),E=n(!1),Q=n([]),c=n([]),ye=n([]),f=n(""),Y=n(null),G=n(0),b=n(0),L=n(!0),z=n(0),A=n([]),N=n(new Set);function F(t,e=1){const s=new Audio(t);return s.preload="auto",s.volume=e,s}const ee=F(Ge,1),te=F(Ne,.3);F(Ke,.5);function se(){try{ee.currentTime=0,ee.play()}catch{}}function _e(){try{te.currentTime=0,te.play()}catch{}}const ae=x(()=>u.value==="easy"?1:3),y=x(()=>u.value==="easy"?2:5),p=n(y.value);Xe(u,()=>{p.value=y.value});const P=n([]);let ke=1;function be(t){const e=Math.random()<.5?"left":"right",s=ke++;P.value.push({id:s,text:`+${t}xp`,side:e}),setTimeout(()=>{P.value=P.value.filter(i=>i.id!==s)},2400)}const m=x(()=>{if(!g.value.length)return null;const t=g.value[_.value];return W.value[t]??null}),q=x(()=>{const t=_.value,e=g.value.length;return e>0?Math.round(t/e*100):0}),le=x(()=>{const t=m.value?.japanese;return!t||typeof t=="string"?"":t?.kanji??""}),we=x(()=>{const t=[];let e=[];for(const s of Q.value)s.type==="space"?(e.length&&(t.push({type:"word",slots:e}),e=[]),t.push({type:"space"})):e.push({index:s.index,ch:s.ch});return e.length&&t.push({type:"word",slots:e}),t});$e(async()=>{try{let t=[];if(I.cards?.length)t=I.cards;else{const s=J.query.deckId||J.params.id||I.deckId;if(!s)throw new Error("No cards or deckId provided.");t=await xe(s)}const e=t.filter(s=>!!s.english?.trim());if(!e.length)throw new Error("No usable cards found for Spelling Blitz.");W.value=e,g.value=ce(Array.from(e.keys())),_.value=0,H(),$.value=!1,d()}catch(t){U.value=t?.message??"Failed to load cards.",$.value=!1}});async function xe(t){const{data:e,error:s}=await de.from("v_deck_cards_expanded").select(`
      deck_id,
      card_id,
      english,
      japanese_kanji,
      japanese_furigana,
      image_url,
      audio_url,
      tags,
      card_tags,
      position
    `).eq("deck_id",t).order("position",{ascending:!0});if(s)throw s;const i=l=>{if(!l)return"";const{data:h}=de.storage.from("public-assets").getPublicUrl(l);return h?.publicUrl??""};return(e||[]).map(l=>({id:l.card_id,english:l.english??"",japanese:{kanji:l.japanese_kanji??void 0,furigana:l.japanese_furigana??void 0},image_url:i(l.image_url)}))}function H(){L.value=!0,N.value.clear(),p.value=y.value;const t=m.value;if(!t)return;const e=(t.english??"").replace(/[^A-Za-z ]/g," ").replace(/\s+/g," ").trim(),s=e.replace(/ /g,"");f.value=s,c.value=Array(s.length).fill(""),ye.value=s.split("");const i=[];let l=0;for(const h of e)h===" "?i.push({type:"space"}):/[A-Za-z]/.test(h)&&(i.push({type:"letter",index:l,ch:s[l]}),l++);Q.value=i,G.value=performance.now()}function K(){k.value=!0,D.value=!1,E.value=!1,z.value=0,A.value=[],_.value=0,g.value.length||(g.value=ce(Array.from(W.value.keys()))),H(),d()}function ne(){_.value++,_.value>=g.value.length?oe():(H(),d())}function oe(){D.value=!0,L.value=!1,k.value=!1,setTimeout(()=>ze(),250)}function d(){requestAnimationFrame(()=>Y.value?.focus({preventScroll:!0}))}function Ce(t){if(!L.value||D.value)return;const e=t.key;if(e==="Enter"||e==="Tab"){t.preventDefault(),T()&&R();return}if(e==="Backspace"){t.preventDefault(),Le();return}if((t.ctrlKey||t.metaKey)&&(e.toLowerCase()==="k"||e.toLowerCase()==="s")){t.preventDefault(),ue(),d();return}/^[a-zA-Z]$/.test(e)&&(t.preventDefault(),Se(e))}function re(){for(let t=0;t<c.value.length;t++)if(c.value[t]==="")return t;return-1}function Se(t){const e=re();e!==-1&&(c.value[e]=t,se(),T()&&R())}function Le(){for(let t=c.value.length-1;t>=0;t--)if(c.value[t]!==""){c.value[t]="";break}}function T(){return f.value.length?c.value.join("").toLowerCase()===f.value.toLowerCase():!1}function ue(){b.value=Math.max(0,Math.floor(performance.now()-G.value));const t=m.value;A.value.push({cardId:t.id,english:f.value,letters:f.value.length,ms:b.value,xpLetters:0,xpBonus:0,xpTotal:0}),ne()}function Te(){if(u.value!=="hard")return;const t=re();t!==-1&&(c.value[t]=f.value[t],N.value.add(t),p.value=y.value,se(),T()&&R(),d())}async function R(){L.value=!1,b.value=Math.max(1,Math.floor(performance.now()-G.value));const t=f.value.length,e=t-N.value.size,s=Math.max(0,e)*ae.value,i=b.value/1e3,l=t/Math.max(.5,i),h=Math.max(0,Math.round(l*p.value)),Z=s+h,Ae=_.value>=g.value.length-1?650:220;_e(),await ie(s,"spelling_blitz",{reason:"letters",mode:u.value,cardId:m.value?.id,english:f.value,ms:b.value}),await ie(h,"spelling_blitz",{reason:"completion_bonus",mode:u.value,cardId:m.value?.id,english:f.value,ms:b.value}),z.value+=Z,A.value.push({cardId:m.value.id,english:f.value,letters:t,ms:b.value,xpLetters:s,xpBonus:h,xpTotal:Z}),be(Z),setTimeout(()=>{L.value=!0,ne()},Ae)}async function ie(t,e,s){try{if(t<=0)return;await Be(t,e,s)}catch{}}async function Be(t,e,s){}const B=n(!1);function Me(){B.value=!B.value,d()}function w(){B.value=!1,d()}function Ie(){w(),oe()}function je(){w(),K()}function ce(t){const e=t.slice();for(let s=e.length-1;s>0;s--){const i=Math.floor(Math.random()*(s+1));[e[s],e[i]]=[e[i],e[s]]}return e}function Ee(){ge.back()}const V=n([]);async function ze(){E.value=!0,V.value=[];const t=A.value.slice();let e=0;const s=window.setInterval(()=>{if(e>=t.length){clearInterval(s);return}V.value.push(t[e++])},150);await qe(),window.setTimeout(()=>{const i=z.value;if(i<=0)return;const l=Math.round(i*.8),h=i-l;j.value?.open(),j.value?.addReadingXp(h),j.value?.addWritingXp(l)},400)}return(t,e)=>(r(),o("div",{class:"sb-page",onClick:e[8]||(e[8]=he(s=>d(),["self"]))},[a("button",{class:"back-btn",type:"button",onClick:Ee,title:"Back"},"← Back"),a("header",Ve,[e[11]||(e[11]=a("div",{class:"left"},[a("h1",{class:"title"},"Spelling Blitz")],-1)),a("div",Ze,[a("div",Oe,[e[9]||(e[9]=a("span",{class:"k"},"XP",-1)),a("span",Je,v(z.value),1)]),a("div",Qe,[e[10]||(e[10]=a("span",{class:"k"},"Progress",-1)),a("span",Ye,v(q.value)+"%",1)]),k.value?(r(),o("button",{key:0,class:"btn danger",onClick:Ie,title:"End Game"}," ⏹ End Game ")):C("",!0),k.value?(r(),o("button",{key:1,class:"btn settings-btn","aria-expanded":B.value,onClick:Me}," ⚙ Settings ",8,et)):C("",!0)])]),a("main",tt,[$.value?(r(),o("p",st,"Loading cards…")):U.value?(r(),o("p",at,v(U.value),1)):(r(),o("section",{key:2,class:"arena",onClick:d},[a("div",{class:"progress-bar",role:"progressbar","aria-valuenow":q.value,"aria-valuemin":"0","aria-valuemax":"100"},[a("div",{class:"bar",style:We({width:q.value+"%"})},null,4)],8,lt),a("div",nt,[(r(),o("div",{class:"multiplier-chip",key:p.value}," x"+v(p.value),1))]),!k.value&&!E.value?(r(),o("div",ot,[a("div",rt,[a("button",{class:S(["mode-big",{active:u.value==="easy"}]),onClick:e[0]||(e[0]=s=>{u.value="easy",p.value=y.value,d()}),"aria-pressed":u.value==="easy"}," Easy ",10,ut),a("button",{class:S(["mode-big",{active:u.value==="hard"}]),onClick:e[1]||(e[1]=s=>{u.value="hard",p.value=y.value,d()}),"aria-pressed":u.value==="hard"}," Hard ",10,it)]),a("button",{class:"btn start-big",onClick:K},"Start")])):k.value&&m.value?(r(),o("div",{key:1,class:"card-area",onClick:d},[a("figure",ct,[le.value?(r(),o("div",dt,v(le.value),1)):C("",!0),a("div",vt,[a("img",{src:m.value.image_url||"",alt:m.value.english,onError:e[2]||(e[2]=s=>s.target.style.visibility="hidden")},null,40,pt)])]),O(pe,{name:"burst",tag:"div",class:"bursts"},{default:ve(()=>[(r(!0),o(M,null,X(P.value,s=>(r(),o("div",{key:s.id,class:S(["burst",s.side])},v(s.text),3))),128))]),_:1}),a("div",ft,[a("div",{class:"boxes",onClick:d},[(r(!0),o(M,null,X(we.value,(s,i)=>(r(),o(M,{key:i},[s.type==="word"?(r(),o("div",ht,[(r(!0),o(M,null,X(s.slots,l=>(r(),o("div",{key:l.index,class:S(["box",{filled:c.value[l.index]!=="",correct:c.value[l.index]!==""&&c.value[l.index]?.toLowerCase()===l.ch.toLowerCase(),incorrect:c.value[l.index]!==""&&c.value[l.index]?.toLowerCase()!==l.ch.toLowerCase()}])},[a("span",mt,v(c.value[l.index]),1),u.value==="easy"&&c.value[l.index]===""?(r(),o("span",gt,v(l.ch.toUpperCase()),1)):C("",!0)],2))),128))])):(r(),o("div",yt))],64))),128))]),a("input",{ref_key:"inputEl",ref:Y,class:"hidden-input",type:"text",onKeydown:Ce,autocomplete:"off",autocapitalize:"none",spellcheck:"false","aria-label":"Type the word"},null,544),a("div",_t,[a("button",{class:"btn hint",onClick:e[3]||(e[3]=s=>{Te(),d()}),disabled:u.value!=="hard"},"Hint",8,kt),a("button",{class:"btn",onClick:e[4]||(e[4]=s=>{ue(),d()}),disabled:!k.value},"Skip",8,bt),a("button",{class:"btn success",onClick:e[5]||(e[5]=s=>{T()&&R(),d()}),disabled:!T()},"Confirm",8,wt)]),a("p",xt,[e[12]||(e[12]=fe(" Per-letter XP: ",-1)),a("strong",null,v(ae.value),1),e[13]||(e[13]=fe("  •  Speed bonus multiplier: ",-1)),a("strong",null,"x"+v(p.value),1)])])])):E.value?(r(),o("div",Ct,[a("table",St,[e[14]||(e[14]=a("thead",null,[a("tr",null,[a("th",null,"Word"),a("th",null,"Letters"),a("th",null,"Time (s)"),a("th",null,"Letters XP"),a("th",null,"Bonus XP"),a("th",null,"Total")])],-1)),O(pe,{name:"rowgrow",tag:"tbody"},{default:ve(()=>[(r(!0),o(M,null,X(V.value,s=>(r(),o("tr",{key:s.cardId+s.ms},[a("td",null,v(s.english),1),a("td",Lt,v(s.letters),1),a("td",Tt,v((s.ms/1e3).toFixed(2)),1),a("td",Bt,v(s.xpLetters),1),a("td",Mt,v(s.xpBonus),1),a("td",It,v(s.xpTotal),1)]))),128))]),_:1})]),a("div",{class:"summary-actions"},[a("button",{class:"btn primary",onClick:K},"Play Again")])])):C("",!0)]))]),B.value?(r(),o("div",{key:0,class:"settings-overlay",onClick:he(w,["self"])},[a("div",jt,[e[16]||(e[16]=a("h3",null,"Settings",-1)),a("div",Et,[e[15]||(e[15]=a("span",null,"Difficulty",-1)),a("div",zt,[a("button",{class:S(["seg-btn",{active:u.value==="easy"}]),onClick:e[6]||(e[6]=s=>{u.value="easy",p.value=y.value,w()})},"Easy",2),a("button",{class:S(["seg-btn",{active:u.value==="hard"}]),onClick:e[7]||(e[7]=s=>{u.value="hard",p.value=y.value,w()})},"Hard",2)])]),a("div",{class:"row"},[a("button",{class:"btn",onClick:je},"Restart"),a("button",{class:"btn",onClick:w},"Close")])])])):C("",!0),O(De,{ref_key:"levelsRef",ref:j,overlay:!0},null,512)]))}}),$t=He(At,[["__scopeId","data-v-05f066e1"]]);export{$t as default};
