import{d as Xe,c as E,W as ze,r as o,Q as He,o as Ye,g as Qe,a as u,b as a,B as N,p as w,K as Ze,F as ke,h as Te,e as G,t as k,n as re,u as et,f as r,_ as tt}from"./index-D3ut4Aj4.js";import{i as at}from"./megaphone-Cs9AbUGH.js";import{h as ce}from"./home-icon-CTPXHMtR.js";const de="/TaiyakiEduGames/assets/crumpled-paper-01-DgenSUyW.png",nt="/TaiyakiEduGames/assets/lightning-CCXBJAMJ.png",st="/TaiyakiEduGames/assets/exclamation-B3f_PXL-.png",ot="/TaiyakiEduGames/assets/lightbulb-BjCfPZLz.png",lt="/TaiyakiEduGames/assets/on-the-beat-Da7e9R4L.mp3",it=["src"],ut=["src"],rt=["src"],ct=["src"],dt=["src"],vt={key:0,class:"menu","aria-label":"On The Beat menu"},mt={class:"menu-grid"},ht={class:"menu-card"},ft={class:"menu-card__row"},gt=["disabled","onClick"],_t={class:"menu-card"},bt={class:"menu-card__row"},pt={class:"menu-card"},yt={class:"menu-card__row"},wt={class:"menu-card menu-card--start"},Mt=["disabled"],St={key:0,class:"menu-warn"},kt={key:1,class:"game","aria-label":"On The Beat game"},Tt={class:"hud","aria-label":"Game HUD"},xt={class:"hud-center"},Ct={class:"hud-pill hud-pill--round"},Bt={class:"hud-debug","aria-hidden":"true"},Et={class:"hud-pill hud-pill--debug"},At={class:"board","aria-label":"Card board"},It={key:0,class:"finish-center","aria-label":"Finish"},Pt={key:1,class:"card-grid",role:"grid","aria-label":"8 cards"},Dt={class:"beat-card__inner"},Ft={key:0,class:"beat-card__jp"},Rt={class:"beat-card__img-wrap"},Nt=["src"],Gt={class:"beat-card__text"},Lt={key:0,class:"beat-card__en"},$t={key:0,class:"overlay overlay--loading",role:"status","aria-live":"polite"},qt={class:"overlay-card"},Ot={class:"overlay-progress"},Ut={class:"bar"},jt={class:"pct"},Jt={key:1,class:"overlay overlay--countdown",role:"status","aria-live":"polite"},Kt={class:"countdown-card"},Vt={class:"countdown-num"},xe="eitake.onthebeat.transit.v1",ve=8,me=5,Q=16,Ce=30,Wt=.885,Be=520,Xt=Xe({__name:"OnTheBeat",props:{cards:{}},setup(Ee){const Ae=E(()=>({"--otb-bg-url":`url("${de}")`})),Z=at,ee=nt,te=st,ae=ot,Ie=et(),ne=ze(),he=Ee,se=E(()=>he.cards?.length?he.cards:ne.cards),L=o("menu"),m=o(8),fe=o("normal"),$=o(!0),q=o(!1),f=o([]),oe=E(()=>f.value.length>=3),ge=E(()=>f.value.length),O=E(()=>Math.min(8,ge.value));function Pe(t){t>O.value||(m.value=t)}He(ge,t=>{if(t>=3){const e=Math.min(Math.max(m.value,3),O.value);e!==m.value&&(m.value=e)}else m.value=3},{immediate:!0});const c=o("idle"),le=o(0),T=o(3),U=o(Ce),De=E(()=>{const t=Math.round(U.value*1e3/me);return Math.max(80,Math.round(t/Q*Wt))}),A=o(0),j=o(0),h=o(-1),x=o([]),g=o(0),M=o(!1),I=o(!0),S=o(!1),C=o(!1),J=o(!1);function Fe(t){const e=Math.PI*2*t/8,n=Math.cos(e),s=Math.sin(e),p=130,v=120,l=(t%2===0?1:-1)*(18+t*2);return{"--dx":`${(n*p).toFixed(1)}vw`,"--dy":`${(s*v).toFixed(1)}vh`,"--rot":`${l}deg`,"--sc":`${1.03}`,animationDuration:`${Be}ms`}}let K=null,d=null,_=null,P=null,D=0,V=null,W=null,F=null;function Re(){try{Ie.back()}catch{}}function Ne(t){for(let e=t.length-1;e>0;e--){const n=Math.floor(Math.random()*(e+1));[t[e],t[n]]=[t[n],t[e]]}return t}function Ge(t,e){const n=Ne([...t]);return n.slice(0,Math.min(e,n.length))}function _e(t,e,n){return Math.max(e,Math.min(n,t))}function Le(t){return t?.japanese?.kanji??""}function b(t){return new Promise(e=>{if(!t)return e();const n=new Image;n.decoding="async",n.loading="eager",n.onload=()=>e(),n.onerror=()=>e(),n.src=t})}async function be(){if(K)return K;const t=window.AudioContext||window.webkitAudioContext;return K=new t,K}async function $e(t){const e=await be(),s=await(await fetch(t,{cache:"force-cache"})).arrayBuffer();return await e.decodeAudioData(s)}function qe(){try{const t={cards:f.value};sessionStorage.setItem(xe,JSON.stringify(t))}catch{}}function Oe(){try{const t=sessionStorage.getItem(xe);if(!t)return;const e=JSON.parse(t);Array.isArray(e?.cards)&&e.cards.length&&ne.set({cards:e.cards})}catch{}}function pe(t,e){if(e>=4)return t;const n=t.length,s=e*2%n,p=t[s],v=t[(s+1)%n];return[p,v].filter(Boolean)}function ye(t){const e=[];for(let n=0;n<8;n++){const s=t[Math.floor(Math.random()*t.length)];e.push({...s,_slotKey:`${Date.now()}-${Math.random().toString(16).slice(2)}-${n}`})}return e}function we(t,e){const n=pe(t,e);x.value=ye(n),x.value.forEach(s=>void b(s.image_url))}function Ue(t){if(t<8){h.value=-1;return}const e=t-8;h.value=e>=0&&e<8?e:-1}function X(){W!=null&&(window.clearTimeout(W),W=null),F!=null&&(window.clearTimeout(F),F=null),V!=null&&(window.clearTimeout(V),V=null)}function ie(){A.value=0,j.value=0,h.value=-1,g.value=0,M.value=!1,I.value=!0,S.value=!1,C.value=!1,J.value=!1}function z(){try{_&&_.stop()}catch{}_=null,P=null,D=0}function je(){X(),z(),ie(),x.value=[],c.value="idle",L.value="menu"}function Je(){X(),z(),ie(),x.value=[],c.value="idle",L.value="menu"}function H(){C.value||J.value||(c.value="finished",h.value=-1,M.value=!1,C.value=!0,window.setTimeout(()=>{C.value=!1,x.value=[],J.value=!0},Be+40))}function Me(){X(),H()}function Se(t){const e=De.value,n=ve+me*Q,s=()=>{if(c.value!=="countdown"&&c.value!=="playing")return;const v=performance.now()-D,l=Math.max(0,Math.floor(v/e));if(l>=n){H();return}if(M.value=l%2===1,l<ve)return I.value=!0,S.value=!1,g.value=0,h.value=-1,l<2?T.value=3:l<4?T.value=2:l<6?T.value=1:(T.value=0,c.value="playing"),j.value=0,p(l+1,e);I.value=!1,c.value="playing";const y=l-ve,B=Math.floor(y/Q),i=y%Q;return A.value=_e(B,0,me-1),j.value=i,i===0&&(we(t,A.value),h.value=-1,g.value=0),A.value===0&&i<8?(S.value=!0,g.value=i+1,h.value=-1):(S.value=!1,g.value=8,Ue(i)),p(l+1,e)};function p(v,l){const y=D+v*l,B=Math.max(0,y-performance.now());W=window.setTimeout(s,B)}we(t,0),g.value=0,h.value=-1,I.value=!0,S.value=!1,s()}async function Ke(){if(!oe.value)return;fe.value="normal",c.value="loading",L.value="game",ie();const t=_e(m.value,3,8),e=Ge(f.value,t),n=pe(e,0),s=ye(n),p=[de,Z,ee,te,ae,ce,...f.value.map(R=>R.image_url),...s.map(R=>R.image_url)].filter(Boolean),v=Array.from(new Set(p)),l=v.length+1;let y=0;const B=()=>{y+=1,le.value=Math.min(1,y/l)};await Promise.all(v.map(async R=>{await b(R),B()}));try{d=await $e(lt)}catch{d=null}B(),d?.duration&&Number.isFinite(d.duration)&&d.duration>1?U.value=d.duration:U.value=Ce,c.value="countdown",T.value=3;const i=await be();if(i.state==="suspended"&&await i.resume().catch(()=>{}),z(),!d){D=performance.now()+90,Se(e),F=window.setTimeout(()=>H(),Math.round(U.value*1e3)+900);return}_=i.createBufferSource(),_.buffer=d,P=i.createGain(),P.gain.value=1,_.connect(P),P.connect(i.destination);const Y=120,Ve=(i.baseLatency??0)+(i.outputLatency??0),ue=Math.max(0,Math.round(Ve*1e3)),We=i.currentTime+Y/1e3;_.start(We),D=performance.now()+Y+ue,_.onended=()=>Me(),V=window.setTimeout(()=>Me(),Math.round(d.duration*1e3)+Y+ue+120),Se(e),F=window.setTimeout(()=>{(c.value==="countdown"||c.value==="playing")&&H()},Math.round(d.duration*1e3)+Y+ue+1200)}return Ye(()=>{se.value.length||Oe(),f.value=[...se.value.length?se.value:ne.cards],qe(),f.value.length>=3?m.value=Math.min(8,f.value.length):m.value=3,b(de),b(Z),b(ee),b(te),b(ae),b(ce)}),Qe(()=>{X(),z()}),(t,e)=>(r(),u("section",{class:"otb-page",style:re(Ae.value),"aria-label":"On The Beat"},[e[12]||(e[12]=a("div",{class:"otb-bg","aria-hidden":"true"},null,-1)),e[13]||(e[13]=a("div",{class:"otb-bg-overlay","aria-hidden":"true"},null,-1)),a("button",{class:"home-btn",type:"button",onClick:Re,"aria-label":"Back to deck"},[a("img",{src:N(ce),alt:""},null,8,it)]),a("img",{class:w(["corner-icon tl corner-icon--mega",{"is-beating":M.value}]),src:N(Z),alt:"","aria-hidden":"true"},null,10,ut),a("img",{class:w(["corner-icon tr",{"is-beating":M.value}]),src:N(ee),alt:"","aria-hidden":"true"},null,10,rt),a("img",{class:w(["corner-icon bl",{"is-beating":M.value}]),src:N(te),alt:"","aria-hidden":"true"},null,10,ct),a("img",{class:w(["corner-icon br",{"is-beating":M.value}]),src:N(ae),alt:"","aria-hidden":"true"},null,10,dt),L.value==="menu"?(r(),u("section",vt,[e[8]||(e[8]=Ze('<header class="menu-head" data-v-3731c067><div class="title-stack" aria-label="Game title" data-v-3731c067><div class="title-main" data-v-3731c067>Say the word</div><div class="title-sub" data-v-3731c067>on the beat!</div></div><p class="menu-subtitle" data-v-3731c067>A flashcard rhythm game</p></header>',1)),a("div",mt,[a("div",ht,[e[3]||(e[3]=a("div",{class:"menu-card__title"},"Words",-1)),a("div",ft,[(r(),u(ke,null,Te([3,4,5,6,7,8],n=>a("button",{key:n,class:w(["sq-btn",{"is-active":m.value===n,"is-disabled":n>O.value}]),type:"button",disabled:n>O.value,onClick:s=>Pe(n)},k(n),11,gt)),64))])]),a("div",_t,[e[6]||(e[6]=a("div",{class:"menu-card__title"},"Speed",-1)),a("div",bt,[e[4]||(e[4]=a("button",{class:"sq-btn",type:"button",disabled:"",title:"Placeholder"},"Slow",-1)),a("button",{class:"sq-btn is-active",type:"button",onClick:e[0]||(e[0]=n=>fe.value="normal")},"Normal"),e[5]||(e[5]=a("button",{class:"sq-btn",type:"button",disabled:"",title:"Placeholder"},"Fast",-1))])]),a("div",pt,[e[7]||(e[7]=a("div",{class:"menu-card__title"},"Card Text",-1)),a("div",yt,[a("button",{class:w(["sq-btn",{"is-active":$.value}]),type:"button",onClick:e[1]||(e[1]=n=>$.value=!$.value)}," English ",2),a("button",{class:w(["sq-btn",{"is-active":q.value}]),type:"button",onClick:e[2]||(e[2]=n=>q.value=!q.value)}," Japanese ",2)])]),a("div",wt,[a("button",{class:"sq-btn sq-btn--primary",type:"button",disabled:!oe.value,onClick:Ke}," Start ",8,Mt),oe.value?G("",!0):(r(),u("div",St,"This deck has fewer than 3 cards. Add more cards to play."))])])])):(r(),u("section",kt,[a("header",Tt,[a("div",xt,[a("div",Ct,"Round "+k(A.value+1),1)]),a("div",Bt,[a("div",Et," Beat "+k(j.value+1)+" / 16 ",1)]),a("div",{class:"hud-right"},[a("button",{class:"sq-btn",type:"button",onClick:je},"Stop")])]),a("div",At,[J.value?(r(),u("div",It,[a("button",{class:"sq-btn sq-btn--primary",type:"button",onClick:Je},"Finish")])):(r(),u("div",Pt,[(r(!0),u(ke,null,Te(x.value,(n,s)=>(r(),u("article",{key:n._slotKey,class:w(["beat-card",[I.value?"deal-hidden":"",S.value&&s<g.value?"deal-in":"",S.value&&s>=g.value?"deal-hidden":"",C.value?"explode-out":"",h.value===s?"is-highlighted":""]]),role:"gridcell",style:re(C.value?Fe(s):void 0)},[a("div",Dt,[q.value?(r(),u("div",Ft,k(Le(n)),1)):G("",!0),a("div",Rt,[n.image_url?(r(),u("img",{key:0,class:"beat-card__img",src:n.image_url,alt:"",decoding:"async"},null,8,Nt)):G("",!0)]),a("div",Gt,[$.value?(r(),u("div",Lt,k(n.english??""),1)):G("",!0)])])],6))),128))]))]),c.value==="loading"?(r(),u("div",$t,[a("div",qt,[e[9]||(e[9]=a("div",{class:"overlay-title"},"Loadingâ€¦",-1)),e[10]||(e[10]=a("div",{class:"overlay-sub"},"Preparing images and audio.",-1)),a("div",Ot,[a("div",Ut,[a("div",{class:"bar__fill",style:re({width:`${Math.round(le.value*100)}%`})},null,4)]),a("div",jt,k(Math.round(le.value*100))+"%",1)])])])):c.value==="countdown"?(r(),u("div",Jt,[a("div",Kt,[a("div",Vt,k(T.value),1),e[11]||(e[11]=a("div",{class:"countdown-sub"},"Get ready",-1))])])):G("",!0)]))],4))}}),Qt=tt(Xt,[["__scopeId","data-v-3731c067"]]);export{Qt as default};
