import{d as De,c as E,r as o,Q as Ge,o as qe,g as Ue,a as u,b as t,B as q,p as S,K as $e,e as le,t as x,F as Le,h as Ke,n as ie,u as Ve,f as r,_ as We}from"./index-DG6keRSc.js";import{b as ue,i as Xe,a as ze,c as He,s as Je}from"./on-the-beat-DLHddV1m.js";import{i as Qe}from"./megaphone-Cs9AbUGH.js";import{h as re}from"./home-icon-CTPXHMtR.js";const Ye=["src"],Ze=["src"],et=["src"],tt=["src"],nt=["src"],at={key:0,class:"menu","aria-label":"On The Beat menu"},st={class:"menu-grid"},ot={class:"menu-card"},lt={class:"menu-card__row"},it={class:"menu-card"},ut={class:"menu-card__row"},rt={class:"menu-card menu-card--start"},ct=["disabled"],dt={key:0,class:"menu-warn"},vt={key:1,class:"game","aria-label":"On The Beat game"},ht={class:"hud","aria-label":"Game HUD"},gt={class:"hud-center"},mt={class:"hud-pill hud-pill--round"},pt={class:"hud-debug","aria-hidden":"true"},ft={class:"hud-pill hud-pill--debug"},bt={class:"board","aria-label":"Card board"},_t={key:0,class:"finish-center","aria-label":"Continue/Finish"},yt={key:1,class:"card-grid",role:"grid","aria-label":"8 cards"},wt={class:"beat-card__inner"},jt={key:0,class:"beat-card__jp"},St={class:"beat-card__text beat-card__text--center"},xt={class:"beat-card__en"},Mt={key:0,class:"overlay overlay--loading",role:"status","aria-live":"polite"},Tt={class:"overlay-card"},Bt={class:"overlay-progress"},kt={class:"bar"},Ct={class:"pct"},Et={key:1,class:"overlay overlay--countdown",role:"status","aria-live":"polite"},It={class:"countdown-card"},Nt={class:"countdown-num"},ce=8,de=5,J=16,fe=30,Rt=.88,be=520,Ot=De({__name:"OnTheBeat",setup(Pt){const _e=Ve(),ye=E(()=>({"--otb-bg-url":`url("${ue}")`})),Q=Qe,Y=Xe,Z=ze,ee=He,U=o("menu"),M=o("pronouns"),te=o(!0),$=o(!1),i=o("idle"),L=o(0),T=o(3),ne={pronouns:{label:"Pronouns",games:[[[{english:"I",jp:"わたし"},{english:"my",jp:"わたしの"},{english:"me",jp:"わたしを／に"},{english:"mine",jp:"わたしのもの"}],[{english:"you",jp:"あなた"},{english:"your",jp:"あなたの"},{english:"you",jp:"あなたを／に"},{english:"yours",jp:"あなたのもの"}],[{english:"it",jp:"それ"},{english:"its",jp:"それの"},{english:"it",jp:"それを／に"},{english:"X",jp:"—"}],[{english:"Mao",jp:"マオ"},{english:"Mao’s",jp:"マオの"},{english:"Mao",jp:"マオ"},{english:"Mao’s",jp:"マオの"}],[{english:"Ken",jp:"ケン"},{english:"Ken’s",jp:"ケンの"},{english:"Ken",jp:"ケン"},{english:"Ken’s",jp:"ケンの"}]],[[{english:"he",jp:"かれ"},{english:"his",jp:"かれの"},{english:"him",jp:"かれを／に"},{english:"his",jp:"かれのもの"}],[{english:"she",jp:"かのじょ"},{english:"her",jp:"かのじょの"},{english:"her",jp:"かのじょを／に"},{english:"hers",jp:"かのじょのもの"}],[{english:"we",jp:"わたしたち"},{english:"our",jp:"わたしたちの"},{english:"us",jp:"わたしたちを／に"},{english:"ours",jp:"わたしたちのもの"}],[{english:"you",jp:"あなた(たち)"},{english:"your",jp:"あなた(たち)の"},{english:"you",jp:"あなた(たち)を／に"},{english:"yours",jp:"あなた(たち)のもの"}],[{english:"they",jp:"かれら／かのじょら"},{english:"their",jp:"かれらの"},{english:"them",jp:"かれらを／に"},{english:"theirs",jp:"かれらのもの"}]]]}},b=o(0),ae=E(()=>ne[M.value].games.length),we=E(()=>ae.value*5),je=E(()=>b.value*5+N.value+1),B=o(!1),I=o(!1),K=o(fe),Se=E(()=>{const n=Math.round(K.value*1e3/de);return Math.max(80,Math.round(n/J*Rt))}),N=o(0),V=o(0),d=o(-1),k=o([]),g=o(0),_=o(!1),R=o(!0),y=o(!1),C=o(!1);function xe(n){const e=Math.PI*2*n/8,a=Math.cos(e),l=Math.sin(e),j=130,p=120,f=(n%2===0?1:-1)*(18+n*2);return{"--dx":`${(a*j).toFixed(1)}vw`,"--dy":`${(l*p).toFixed(1)}vh`,"--rot":`${f}deg`,"--sc":`${1.03}`,animationDuration:`${be}ms`}}let W=null,c=null,m=null,O=null,P=0,X=null,z=null,A=null;const se=E(()=>!!ne[M.value]?.games?.length);Ge(M,()=>{te.value=!0},{immediate:!0});function Me(n){M.value=n,te.value=!0}function Te(){try{_e.back()}catch{}}function w(n){return new Promise(e=>{if(!n)return e();const a=new Image;a.decoding="async",a.loading="eager",a.onload=()=>e(),a.onerror=()=>e(),a.src=n})}async function ve(){if(W)return W;const n=window.AudioContext||window.webkitAudioContext;return W=new n,W}async function Be(n){const e=await ve(),l=await(await fetch(n,{cache:"force-cache"})).arrayBuffer();return await e.decodeAudioData(l)}function ke(n,e,a){return ne[n].games[e][a]}function Ce(n){return[...n,...n].map((a,l)=>({...a,_slotKey:`${Date.now()}-${Math.random().toString(16).slice(2)}-${l}`}))}function he(n,e,a){const l=ke(n,e,a);k.value=Ce(l)}function Ee(n){if(n<8){d.value=-1;return}const e=n-8;d.value=e>=0&&e<8?e:-1}function F(){z!=null&&(window.clearTimeout(z),z=null),A!=null&&(window.clearTimeout(A),A=null),X!=null&&(window.clearTimeout(X),X=null)}function oe(n=!0){N.value=0,V.value=0,d.value=-1,g.value=0,_.value=!1,R.value=!0,y.value=!1,C.value=!1,B.value=!1,I.value=!1,n&&(b.value=0)}function D(){try{m&&m.stop()}catch{}m=null,O=null,P=0}function Ie(){F(),D(),oe(!0),k.value=[],i.value="idle",U.value="menu"}function Ne(){F(),D(),oe(!0),k.value=[],i.value="idle",U.value="menu"}function H(){C.value||B.value||I.value||(i.value="finished",d.value=-1,_.value=!1,C.value=!0,window.setTimeout(()=>{C.value=!1,k.value=[];const n=b.value<ae.value-1;B.value=n,I.value=!n},be+40))}function ge(){F(),H()}function me(n,e){const a=Se.value,l=ce+de*J,j=()=>{if(i.value!=="countdown"&&i.value!=="playing")return;const f=performance.now()-P,s=Math.max(0,Math.floor(f/a));if(s>=l){H();return}if(_.value=s%2===1,s<ce)return R.value=!0,y.value=!1,g.value=0,d.value=-1,s<2?T.value=3:s<4?T.value=2:s<6?T.value=1:(T.value=0,i.value="playing"),V.value=0,p(s+1,a);R.value=!1,i.value="playing";const v=s-ce,G=Math.floor(v/J),h=v%J;return N.value=Re(G,0,de-1),V.value=h,h===0&&(he(n,e,N.value),d.value=-1,g.value=0),N.value===0&&h<8?(y.value=!0,g.value=h+1,d.value=-1):(y.value=!1,g.value=8,Ee(h)),p(s+1,a)};function p(f,s){const v=P+f*s,G=Math.max(0,v-performance.now());z=window.setTimeout(j,G)}he(n,e,0),g.value=0,d.value=-1,R.value=!0,y.value=!1,j()}function Re(n,e,a){return Math.max(e,Math.min(a,n))}async function Oe(){b.value=0,await pe()}async function Pe(){b.value>=ae.value-1||(F(),D(),b.value+=1,B.value=!1,I.value=!1,await pe())}async function pe(){if(!se.value)return;i.value="loading",U.value="game",oe(!1),k.value=[],L.value=0;const n=M.value,e=b.value,a=[ue,Q,Y,Z,ee,re].filter(Boolean),l=Array.from(new Set(a)),j=l.length+1;let p=0;const f=()=>{p+=1,L.value=Math.min(1,p/j)};await Promise.all(l.map(async Fe=>{await w(Fe),f()}));try{c=await Be(Je)}catch{c=null}f(),c?.duration&&Number.isFinite(c.duration)&&c.duration>1?K.value=c.duration:K.value=fe,i.value="countdown",T.value=3;const s=await ve();if(s.state==="suspended"&&await s.resume().catch(()=>{}),D(),!c){P=performance.now()+90,me(n,e),A=window.setTimeout(()=>H(),Math.round(K.value*1e3)+900);return}m=s.createBufferSource(),m.buffer=c,O=s.createGain(),O.gain.value=1,m.connect(O),O.connect(s.destination);const v=120,G=(s.baseLatency??0)+(s.outputLatency??0),h=Math.max(0,Math.round(G*1e3)),Ae=s.currentTime+v/1e3;m.start(Ae),P=performance.now()+v+h,m.onended=()=>ge(),X=window.setTimeout(()=>ge(),Math.round(c.duration*1e3)+v+h+120),me(n,e),A=window.setTimeout(()=>{(i.value==="countdown"||i.value==="playing")&&H()},Math.round(c.duration*1e3)+v+h+1200)}return qe(()=>{w(ue),w(Q),w(Y),w(Z),w(ee),w(re),te.value=!0}),Ue(()=>{F(),D()}),(n,e)=>(r(),u("section",{class:"otb-page",style:ie(ye.value),"aria-label":"On The Beat — Pronouns"},[e[9]||(e[9]=t("div",{class:"otb-bg","aria-hidden":"true"},null,-1)),e[10]||(e[10]=t("div",{class:"otb-bg-overlay","aria-hidden":"true"},null,-1)),t("button",{class:"home-btn",type:"button",onClick:Te,"aria-label":"Back"},[t("img",{src:q(re),alt:""},null,8,Ye)]),t("img",{class:S(["corner-icon tl corner-icon--mega",{"is-beating":_.value}]),src:q(Q),alt:"","aria-hidden":"true"},null,10,Ze),t("img",{class:S(["corner-icon tr",{"is-beating":_.value}]),src:q(Y),alt:"","aria-hidden":"true"},null,10,et),t("img",{class:S(["corner-icon bl",{"is-beating":_.value}]),src:q(Z),alt:"","aria-hidden":"true"},null,10,tt),t("img",{class:S(["corner-icon br",{"is-beating":_.value}]),src:q(ee),alt:"","aria-hidden":"true"},null,10,nt),U.value==="menu"?(r(),u("section",at,[e[5]||(e[5]=$e('<header class="menu-head" data-v-e9b7c633><div class="title-stack" aria-label="Game title" data-v-e9b7c633><div class="title-main" data-v-e9b7c633>Say the word</div><div class="title-sub" data-v-e9b7c633>on the beat!</div></div><p class="menu-subtitle" data-v-e9b7c633>A rhythm game (fixed sets)</p></header>',1)),t("div",st,[t("div",ot,[e[2]||(e[2]=t("div",{class:"menu-card__title"},"Set",-1)),t("div",lt,[t("button",{class:S(["sq-btn",{"is-active":M.value==="pronouns"}]),type:"button",onClick:e[0]||(e[0]=a=>Me("pronouns"))}," Pronouns ",2)])]),t("div",it,[e[4]||(e[4]=t("div",{class:"menu-card__title"},"Card Text",-1)),t("div",ut,[e[3]||(e[3]=t("button",{class:"sq-btn is-active is-disabled",type:"button",disabled:"",title:"English is required for this set"}," English ",-1)),t("button",{class:S(["sq-btn",{"is-active":$.value}]),type:"button",onClick:e[1]||(e[1]=a=>$.value=!$.value)}," Japanese ",2)])]),t("div",rt,[t("button",{class:"sq-btn sq-btn--primary",type:"button",disabled:!se.value,onClick:Oe}," Play ",8,ct),se.value?le("",!0):(r(),u("div",dt,"This set is unavailable."))])])])):(r(),u("section",vt,[t("header",ht,[t("div",gt,[t("div",mt," Round "+x(je.value)+" / "+x(we.value),1)]),t("div",pt,[t("div",ft," Beat "+x(V.value+1)+" / 16 ",1)]),t("div",{class:"hud-right"},[t("button",{class:"sq-btn",type:"button",onClick:Ie},"Stop")])]),t("div",bt,[B.value||I.value?(r(),u("div",_t,[B.value?(r(),u("button",{key:0,class:"sq-btn sq-btn--primary",type:"button",onClick:Pe}," Continue ")):(r(),u("button",{key:1,class:"sq-btn sq-btn--primary",type:"button",onClick:Ne}," Finish "))])):(r(),u("div",yt,[(r(!0),u(Le,null,Ke(k.value,(a,l)=>(r(),u("article",{key:a._slotKey,class:S(["beat-card no-image",[R.value?"deal-hidden":"",y.value&&l<g.value?"deal-in":"",y.value&&l>=g.value?"deal-hidden":"",C.value?"explode-out":"",d.value===l?"is-highlighted":""]]),role:"gridcell",style:ie(C.value?xe(l):void 0)},[t("div",wt,[$.value?(r(),u("div",jt,x(a.jp),1)):le("",!0),t("div",St,[t("div",xt,x(a.english),1)])])],6))),128))]))]),i.value==="loading"?(r(),u("div",Mt,[t("div",Tt,[e[6]||(e[6]=t("div",{class:"overlay-title"},"Loading…",-1)),e[7]||(e[7]=t("div",{class:"overlay-sub"},"Preparing audio.",-1)),t("div",Bt,[t("div",kt,[t("div",{class:"bar__fill",style:ie({width:`${Math.round(L.value*100)}%`})},null,4)]),t("div",Ct,x(Math.round(L.value*100))+"%",1)])])])):i.value==="countdown"?(r(),u("div",Et,[t("div",It,[t("div",Nt,x(T.value),1),e[8]||(e[8]=t("div",{class:"countdown-sub"},"Get ready",-1))])])):le("",!0)]))],4))}}),Ut=We(Ot,[["__scopeId","data-v-e9b7c633"]]);export{Ut as default};
