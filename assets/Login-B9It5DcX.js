import{d as K,A as Q,r as n,o as X,s as x,u as Z,c as ee,B as se,a as t,b as s,e as u,x as ae,v as w,D,t as c,w as te,T as le,l as A,E as y,G as E,f as l,H as F,k as O,_ as oe}from"./index-BMgXBjWP.js";const ie={class:"chalkboard-bg"},ne={class:"login-shell",role:"main"},re={class:"login-card","aria-labelledby":"login-title"},ue={class:"login-head"},de=["src"],ce={class:"main-sub"},pe={key:0},me={key:1},ve={key:1,class:"info",style:{"margin-top":"8px"}},ge={class:"field-wrap"},fe={class:"field-wrap has-addon"},we=["type"],ye=["aria-pressed","title"],he={key:0,xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24","aria-hidden":"true",class:"icon"},be={key:1,xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24","aria-hidden":"true",class:"icon"},_e={key:0,class:"error"},ke={key:1,class:"info"},xe=["disabled"],Ce={key:0},Se={key:1},Pe={class:"field-wrap"},Ae={class:"field-wrap"},Ee={class:"field-wrap has-addon"},ze=["type"],Me=["aria-pressed","title"],Ue={key:0,xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24","aria-hidden":"true",class:"icon"},Te={key:1,xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24","aria-hidden":"true",class:"icon"},Be={key:0,class:"error"},qe={key:1,class:"info"},Le=["disabled"],Ve={key:0},Ie={key:1},Re={class:"modal",role:"dialog","aria-modal":"true","aria-labelledby":"reset-title"},Ne={key:0,class:"error",style:{"margin-top":"6px"}},De={key:1,class:"info",style:{"margin-top":"6px"}},Fe={class:"modal-actions"},Oe=["disabled"],$e=["disabled"],He={key:0},We={key:1},Ye=K({__name:"Login",setup(Ge){function T(a){if(!a){localStorage.removeItem("org_ctx");return}localStorage.setItem("org_ctx",JSON.stringify(a))}async function B(a){const{data:e,error:o}=await x.from("org_memberships").select("org_id, role").eq("user_id",a).limit(1).maybeSingle();return o||!e?null:{org_id:e.org_id,role:e.role||void 0}}const i=Q(),q=Z(),L=se(),h=n("signin"),b=n(""),_=n(""),p=n(!1),C=n(""),k=n(""),S=n(""),m=n(!1),r=n(null),d=n(null),z=n(!1),P=n(""),v=n(!1),g=n(null),f=n(null);function $(){p.value=!p.value}function H(){m.value=!m.value}function W(a){return a.replace(/\s+/g," ").trim()}X(async()=>{const a=new URLSearchParams(window.location.hash.substring(1)),e=a.get("access_token"),o=a.get("type");e&&o==="signup"&&(await new Promise(N=>setTimeout(N,500)),window.history.replaceState(null,"",window.location.pathname+"?confirmed=1"));const{data:M}=await x.auth.getSession(),R=M.session?.user;if(R){try{i.profile||await i.loadProfile?.()}catch(U){console.error("Error loading profile:",U)}if(!localStorage.getItem("org_ctx")){const U=await B(R.id).catch(()=>null);T(U)}q.replace("/")}});const V=ee(()=>L.query.confirmed==="1"?"Email confirmed. Please log in.":null);async function Y(){await O(async()=>{d.value=null,r.value=null;try{await i.signInWithPassword(b.value,_.value);const{data:{user:a}}=await x.auth.getUser();if(a&&!a.email_confirmed_at){r.value="Please confirm your email address before signing in. Check your inbox.",await x.auth.signOut();return}i.profile||await i.loadProfile();const e=i.session?.user?.id;if(e){const M=await B(e).catch(()=>null);T(M)}const o=L.query.redirect||"/";await q.replace(o)}catch(a){a?.message?.includes("Email not confirmed")?r.value="Please confirm your email address first. Check your inbox.":a?.message?.includes("Invalid login credentials")?r.value="Invalid email or password. Please try again.":r.value=i.error||a?.message||"Could not sign in. Please try again.",_.value=""}},150)}async function G(){await O(async()=>{d.value=null,r.value=null;try{const a=W(C.value);if(!a){r.value="Please enter your name.";return}const e=`${window.location.origin}/login`;if(!(await i.signUpUser(k.value,S.value,a,e))?.ok){i.error?.includes("already registered")?r.value="This email is already registered. Try logging in instead.":r.value=i.error||"Could not create your account.";return}d.value="Account created! Check your email for a confirmation link. After confirming, return here to sign in.",h.value="signin",b.value=k.value,_.value="",C.value="",k.value="",S.value=""}catch(a){console.error("Sign up error:",a),r.value=i.error||a?.message||"Sign up failed. Please try again."}},150)}function J(){g.value=null,f.value=null,P.value=b.value||"",z.value=!0}function I(){v.value||(z.value=!1,g.value=null,f.value=null)}async function j(){g.value=null,f.value=null,v.value=!0;try{const a=`${window.location.origin}/reset-password`,{error:e}=await x.auth.resetPasswordForEmail(P.value,{redirectTo:a});e&&console.warn("resetPasswordForEmail error:",e.message),f.value="We’ve sent a reset link!"}catch(a){g.value=a?.message||"Could not start password reset."}finally{v.value=!1}}return(a,e)=>(l(),t("div",ie,[s("main",ne,[s("section",re,[s("header",ue,[w(D)?(l(),t("img",{key:0,class:"brand-logo",src:w(D),alt:"EiTake"},null,8,de)):u("",!0),e[8]||(e[8]=s("h1",{id:"login-title",class:"main-title"},"英タケ",-1)),s("p",ce,[h.value==="signin"?(l(),t("span",pe,"Log in with your email to continue.")):(l(),t("span",me,"Create a free account to get started."))]),V.value?(l(),t("p",ve,c(V.value),1)):u("",!0)]),ae(le,{name:"fade-swap",mode:"out-in"},{default:te(()=>[h.value==="signin"?(l(),t("form",{key:"signin",class:"login-form",onSubmit:A(Y,["prevent"])},[e[11]||(e[11]=s("label",{class:"field-label",for:"email"},"Email",-1)),s("div",ge,[y(s("input",{id:"email","onUpdate:modelValue":e[0]||(e[0]=o=>b.value=o),type:"email",inputmode:"email",autocomplete:"email",placeholder:"you@example.com",class:"field-input",required:""},null,512),[[E,b.value,void 0,{trim:!0}]])]),e[12]||(e[12]=s("label",{class:"field-label",for:"password"},"Password",-1)),s("div",fe,[y(s("input",{id:"password",type:p.value?"text":"password","onUpdate:modelValue":e[1]||(e[1]=o=>_.value=o),autocomplete:"current-password",placeholder:"••••••••",class:"field-input",required:""},null,8,we),[[F,_.value]]),s("button",{class:"icon-btn hover-scale",type:"button","aria-pressed":p.value?"true":"false",title:p.value?"Hide password":"Show password",onClick:$},[p.value?(l(),t("svg",be,[...e[10]||(e[10]=[s("path",{d:"M2 4.27 3.28 3 21 20.72 19.73 22l-2.39-2.39A12.2 12.2 0 0 1 12 20c-5.05 0-9.27-3.11-10.94-7.5a13.7 13.7 0 0 1 5.18-6.33L2 4.27zM12 7c4.06 0 7.52 2.44 8.95 5.5-.59 1.31-1.49 2.47-2.61 3.42l-2-2a5 5 0 0 0-6.76-6.76l-1.7-1.7A13.85 13.85 0 0 1 12 7zm-3.5 6a3.5 3.5 0 0 0 4.41 3.37l-4.28-4.28A3.47 3.47 0 0 0 8.5 13z"},null,-1)])])):(l(),t("svg",he,[...e[9]||(e[9]=[s("path",{d:"M12 5c5.05 0 9.27 3.11 10.94 7.5C21.27 16.89 17.05 20 12 20S2.73 16.89 1.06 12.5C2.73 8.11 6.95 5 12 5zm0 2C7.94 7 4.48 9.44 3.05 12.5 4.48 15.56 7.94 18 12 18s7.52-2.44 8.95-5.5C19.52 9.44 16.06 7 12 7zm0 2.5A3.5 3.5 0 1 1 8.5 13 3.5 3.5 0 0 1 12 9.5zm0 2A1.5 1.5 0 1 0 13.5 13 1.5 1.5 0 0 0 12 11.5z"},null,-1)])]))],8,ye)]),s("div",{class:"link-row"},[s("button",{class:"link-btn",type:"button",onClick:J}," Forgot password? ")]),r.value?(l(),t("p",_e,c(r.value),1)):u("",!0),d.value?(l(),t("p",ke,c(d.value),1)):u("",!0),s("button",{class:"primary-btn hover-scale",type:"submit",disabled:w(i).loadingAuth},[w(i).loadingAuth?(l(),t("span",Ce,"Signing in…")):(l(),t("span",Se,"Log in"))],8,xe),s("button",{class:"sign-up-btn hover-scale",type:"button",onClick:e[2]||(e[2]=o=>h.value="signup")}," Create a free account ")],32)):(l(),t("form",{key:"signup",class:"login-form",onSubmit:A(G,["prevent"]),autocomplete:"on"},[e[15]||(e[15]=s("label",{class:"field-label",for:"signup-name"},"Display name",-1)),s("div",Pe,[y(s("input",{id:"signup-name","onUpdate:modelValue":e[3]||(e[3]=o=>C.value=o),type:"text",autocomplete:"name",placeholder:"Your name",class:"field-input",required:"",maxlength:"40"},null,512),[[E,C.value]])]),e[16]||(e[16]=s("label",{class:"field-label",for:"signup-email"},"Email",-1)),s("div",Ae,[y(s("input",{id:"signup-email","onUpdate:modelValue":e[4]||(e[4]=o=>k.value=o),type:"email",inputmode:"email",autocomplete:"email",placeholder:"you@example.com",class:"field-input",required:""},null,512),[[E,k.value,void 0,{trim:!0}]])]),e[17]||(e[17]=s("label",{class:"field-label",for:"signup-password"},"Password",-1)),s("div",Ee,[y(s("input",{id:"signup-password",type:m.value?"text":"password","onUpdate:modelValue":e[5]||(e[5]=o=>S.value=o),autocomplete:"new-password",placeholder:"At least 8 characters",minlength:"8",class:"field-input",required:""},null,8,ze),[[F,S.value]]),s("button",{class:"icon-btn hover-scale",type:"button","aria-pressed":m.value?"true":"false",title:m.value?"Hide password":"Show password",onClick:H},[m.value?(l(),t("svg",Te,[...e[14]||(e[14]=[s("path",{d:"M2 4.27 3.28 3 21 20.72 19.73 22l-2.39-2.39A12.2 12.2 0 0 1 12 20c-5.05 0-9.27-3.11-10.94-7.5a13.7 13.7 0 0 1 5.18-6.33L2 4.27zM12 7c4.06 0 7.52 2.44 8.95 5.5-.59 1.31-1.49 2.47-2.61 3.42l-2-2a5 5 0 0 0-6.76-6.76l-1.7-1.7A13.85 13.85 0 0 1 12 7zm-3.5 6a3.5 3.5 0 0 0 4.41 3.37l-4.28-4.28A3.47 3.47 0 0 0 8.5 13z"},null,-1)])])):(l(),t("svg",Ue,[...e[13]||(e[13]=[s("path",{d:"M12 5c5.05 0 9.27 3.11 10.94 7.5C21.27 16.89 17.05 20 12 20S2.73 16.89 1.06 12.5C2.73 8.11 6.95 5 12 5zm0 2C7.94 7 4.48 9.44 3.05 12.5 4.48 15.56 7.94 18 12 18s7.52-2.44 8.95-5.5C19.52 9.44 16.06 7 12 7zm0 2.5A3.5 3.5 0 1 1 8.5 13 3.5 3.5 0 0 1 12 9.5zm0 2A1.5 1.5 0 1 0 13.5 13 1.5 1.5 0 0 0 12 11.5z"},null,-1)])]))],8,Me)]),r.value?(l(),t("p",Be,c(r.value),1)):u("",!0),d.value?(l(),t("p",qe,c(d.value),1)):u("",!0),s("button",{class:"primary-btn hover-scale",type:"submit",disabled:w(i).loadingAuth},[w(i).loadingAuth?(l(),t("span",Ve,"Creating account…")):(l(),t("span",Ie,"Create account"))],8,Le),s("button",{class:"back-btn hover-scale",type:"button",onClick:e[6]||(e[6]=o=>h.value="signin")}," Back to sign in ")],32))]),_:1})])]),z.value?(l(),t("div",{key:0,class:"modal-backdrop",onClick:A(I,["self"]),"aria-hidden":"false"},[s("div",Re,[e[19]||(e[19]=s("h3",{id:"reset-title"},"Reset your password",-1)),e[20]||(e[20]=s("p",{class:"muted",style:{"margin-top":"2px"}},"Enter the email you use for EiTake.",-1)),s("form",{class:"modal-form",onSubmit:A(j,["prevent"])},[e[18]||(e[18]=s("label",{class:"field-label",for:"reset-email"},"Email",-1)),y(s("input",{id:"reset-email","onUpdate:modelValue":e[7]||(e[7]=o=>P.value=o),type:"email",inputmode:"email",autocomplete:"email",placeholder:"you@example.com",class:"field-input",required:""},null,512),[[E,P.value,void 0,{trim:!0}]]),g.value?(l(),t("p",Ne,c(g.value),1)):u("",!0),f.value?(l(),t("p",De,c(f.value),1)):u("",!0),s("div",Fe,[s("button",{class:"back-btn",type:"button",onClick:I,disabled:v.value},"Cancel",8,Oe),s("button",{class:"primary-btn",type:"submit",disabled:v.value},[v.value?(l(),t("span",He,"Sending…")):(l(),t("span",We,"Send reset link"))],8,$e)])],32),e[21]||(e[21]=s("small",{class:"muted",style:{display:"block","margin-top":"10px"}}," You’ll receive an email with a link to set a new password. ",-1))])])):u("",!0)]))}}),je=oe(Ye,[["__scopeId","data-v-300597c7"]]);export{je as default};
