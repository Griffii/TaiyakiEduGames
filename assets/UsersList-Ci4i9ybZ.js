import{d as ce,A as ge,c as C,r as _,o as _e,u as me,s as h,a as m,i as X,b as t,F as Y,e as M,t as n,E as O,J as Z,K as pe,G as ee,z as N,h as fe,P as be,L as he,f as v,n as ye,M as J,_ as ke}from"./index-DsfmNCgp.js";const we={class:"page"},xe={key:0,class:"muted"},Ce={key:1,class:"forbidden"},Me={class:"head"},Ne={class:"left"},Se={key:0,class:"count"},$e={class:"tools"},De={class:"tool"},Le={class:"tool"},Pe={key:0,class:"pager-row right"},Ue={class:"pager"},Te=["disabled"],Be=["disabled"],Ee=["max"],Ie={class:"muted"},Ve=["disabled"],Ae=["disabled"],Fe={key:0,class:"range"},ze={class:"content"},Oe={key:0,class:"muted"},Re={key:1,class:"error"},Ge={key:2,class:"table-outer"},Ke={class:"table-wrap users-wrap",role:"region","aria-label":"Users table",tabindex:"0"},Je={class:"users-table"},We={class:"col-name"},je=["data-active","data-dir"],qe={class:"col-email"},He=["data-active","data-dir"],Qe={class:"col-org"},Xe=["data-active","data-dir"],Ye={class:"col-role"},Ze=["data-active","data-dir"],et={class:"col-level center"},tt=["data-active","data-dir"],lt={class:"col-login"},st=["data-active","data-dir"],at={class:"col-avatar"},ot=["src","onClick"],nt={class:"col-name"},it={class:"name-line"},rt={class:"col-email"},dt={class:"email"},ut={class:"col-org"},vt={class:"org"},ct={class:"col-role"},gt={class:"role"},_t={class:"col-level center"},mt={class:"levels-stack"},pt={class:"skills-row"},ft=["title"],bt=["title"],ht=["title"],yt={class:"col-login"},kt={class:"last"},wt={class:"col-actions"},xt=["onClick","disabled"],Ct={key:0},Mt={class:"pager-row right"},Nt={class:"pager"},St=["disabled"],$t=["disabled"],Dt=["max"],Lt={class:"muted"},Pt=["disabled"],Ut=["disabled"],Tt={key:0,class:"range"},Bt=ce({__name:"UsersList",setup(Et){const S=ge(),te=me(),le=C(()=>S.isDev),R=_(!0);_e(async()=>{if(await S.ensureIdentityLoaded(),await S.checkDevStatus().catch(()=>{}),!S.isDev){R.value=!1,te.replace("/dashboard");return}R.value=!1,await se()});const $=_(!0),G=_(!1),D=_(null),y=_([]),L=C(()=>y.value.length),B=_([]);async function se(){$.value=!0,D.value=null;try{let s=function(r){try{if(!r)return null;const o=S?.orgMap?.[r];return o&&(o.name||o.name||o.org_code)||null}catch{return null}};const{data:e,error:l}=await h.from("xp_levels").select("level, min_xp").order("min_xp",{ascending:!0});if(l)throw l;B.value=e||[];const{data:a,error:u}=await h.from("profiles").select("id, name, email, avatar_url, created_at, last_seen").order("created_at",{ascending:!1});if(u)throw u;const g=a||[],x=g.map(r=>r.id),q={};if(x.length){const{data:r}=await h.from("user_xp_total").select("user_id, xp_total").in("user_id",x);for(const c of r||[])q[c.user_id]=Number(c.xp_total??0)}const z={};if(x.length){const{data:r,error:c}=await h.from("v_profile_progress").select("user_id, reading_level, writing_level, listening_level").in("user_id",x);if(c)throw c;for(const o of r||[])z[o.user_id]={reading_level:Number(o.reading_level??1),writing_level:Number(o.writing_level??1),listening_level:Number(o.listening_level??1)}}const H=new Map,Q=new Map;if(x.length){const{data:r}=await h.from("org_memberships").select("user_id, org_id, role").in("user_id",x);for(const o of r||[])H.set(o.user_id,{org_id:o.org_id,role:o.role});const c=Array.from(new Set((r||[]).map(o=>o.org_id).filter(Boolean)));if(c.length){const{data:o}=await h.from("orgs").select("id, name, org_code").in("id",c);for(const T of o||[])Q.set(T.id,{name:T.name??null,org_code:T.org_code??null})}}y.value=g.map(r=>{const c=H.get(r.id)||{org_id:null,role:null},o=(c.org_id?Q.get(c.org_id):null)||null,T=s(c.org_id)||o?.name||o?.org_code||null;return{...r,xp_total:q[r.id]??0,reading_level:z[r.id]?.reading_level??1,writing_level:z[r.id]?.writing_level??1,listening_level:z[r.id]?.listening_level??1,orgId:c.org_id??null,orgName:T,role:c.role??null}}),I(),f(1)}catch(s){D.value=s?.message??String(s)}finally{$.value=!1}}const d=_("created"),b=_("desc"),E=_([]);function k(s){d.value===s?b.value=b.value==="asc"?"desc":"asc":(d.value=s,b.value=s==="created"||s==="last"||s==="level"?"desc":"asc"),I()}function I(){const s=[...y.value],e=b.value==="asc"?1:-1;s.sort((l,a)=>{let u="",g="";return d.value==="alpha"?(u=l.name||l.email||"",g=a.name||a.email||""):d.value==="email"?(u=l.email||"",g=a.email||""):d.value==="created"?(u=new Date(l.created_at||0).getTime(),g=new Date(a.created_at||0).getTime()):d.value==="last"?(u=new Date(l.last_seen||0).getTime(),g=new Date(a.last_seen||0).getTime()):d.value==="org"?(u=l.orgName||"",g=a.orgName||""):d.value==="role"?(u=l.role||"",g=a.role||""):d.value==="level"&&(u=V(l),g=V(a)),u===g?0:typeof u=="number"&&typeof g=="number"?(u-g)*e:String(u).localeCompare(String(g))*e}),E.value=s,i.value>p.value&&(i.value=p.value||1)}function V(s){const e=Number(s.xp_total??0);if(!B.value.length)return 1;let l=B.value[0]?.level??1;for(const a of B.value)if(e>=Number(a.min_xp))l=a.level;else break;return Math.max(1,Math.min(25,l))}function ae(s){const e=Math.max(1,Math.min(25,s))-1,l=Math.round(e/25*300),a=`hsl(${l} 70% 92%)`,u=`hsl(${(l+24)%360} 65% 82%)`;return{background:`radial-gradient(circle at 30% 30%, ${a}, ${u})`,border:"1px solid rgba(0,0,0,.06)"}}const P=_(25),i=_(1),w=_(1),p=C(()=>Math.max(1,Math.ceil((E.value.length||0)/P.value))),U=C(()=>(i.value-1)*P.value),K=C(()=>Math.min(U.value+P.value,E.value.length)),W=C(()=>E.value.slice(U.value,K.value));function f(s){const e=Math.max(1,Math.min(p.value,s||1));i.value=e,w.value=e}function j(){f(w.value)}function oe(){f(1)}const A=_(!1),F=_(null);function ne(s){A.value=!0,F.value=s}function ie(){A.value=!1,F.value=null}function re(s){const e=s.avatar_url;if(!e)return J;if(/^https?:\/\//i.test(String(e)))return String(e);const{data:l}=h.storage.from("public-assets").getPublicUrl(String(e));return l?.publicUrl||J}function de(s){const e=s.target;e.onerror=null,e.src=J}async function ue(s){if(confirm(`Delete account for "${s.name||s.email||s.id}"?
This can be undone only by a DB admin.`)){G.value=!0;try{const{error:e}=await h.rpc("dev_soft_delete_profile",{user_id:s.id});if(e)throw e;y.value=y.value.filter(l=>l.id!==s.id),I(),U.value>=y.value.length&&i.value>1&&f(i.value-1)}catch(e){alert(e?.message||"Failed to delete account.")}finally{G.value=!1}}}function ve(s,e){const l=s||e;if(!l)return"—";try{const a=new Date(l);return Number.isNaN(a.getTime())?"—":a.toLocaleString()}catch{return"—"}}return(s,e)=>(v(),m("div",we,[R.value?(v(),m("div",xe,"Checking access…")):le.value?(v(),m(Y,{key:2},[t("header",Me,[t("div",Ne,[e[19]||(e[19]=t("h1",{class:"title"},"Users",-1)),$.value?M("",!0):(v(),m("span",Se,"("+n(L.value)+")",1))]),t("div",$e,[t("div",De,[e[21]||(e[21]=t("label",{for:"sortby",class:"muted"},"Sort by:",-1)),O(t("select",{id:"sortby","onUpdate:modelValue":e[0]||(e[0]=l=>d.value=l),onChange:I},[...e[20]||(e[20]=[pe('<option value="alpha" data-v-95955fa7>Alphabetical</option><option value="created" data-v-95955fa7>Date added</option><option value="level" data-v-95955fa7>Level</option><option value="org" data-v-95955fa7>Org</option><option value="role" data-v-95955fa7>Role</option><option value="last" data-v-95955fa7>Last logged in</option><option value="email" data-v-95955fa7>E-mail</option>',7)])],544),[[Z,d.value]])]),t("div",Le,[e[23]||(e[23]=t("label",{for:"pagesize",class:"muted"},"Rows:",-1)),O(t("select",{id:"pagesize","onUpdate:modelValue":e[1]||(e[1]=l=>P.value=l),onChange:oe},[...e[22]||(e[22]=[t("option",{value:10},"10",-1),t("option",{value:25},"25",-1),t("option",{value:50},"50",-1),t("option",{value:100},"100",-1)])],544),[[Z,P.value,void 0,{number:!0}]])])])]),!$.value&&!D.value?(v(),m("div",Pe,[t("div",Ue,[t("button",{class:"btn sm",disabled:i.value===1,onClick:e[2]||(e[2]=l=>f(1))},"« First",8,Te),t("button",{class:"btn sm",disabled:i.value===1,onClick:e[3]||(e[3]=l=>f(i.value-1))},"‹ Prev",8,Be),e[24]||(e[24]=t("span",{class:"muted"},"Page",-1)),O(t("input",{class:"page-input",type:"number",min:1,max:p.value,"onUpdate:modelValue":e[4]||(e[4]=l=>w.value=l),onChange:j},null,40,Ee),[[ee,w.value,void 0,{number:!0}]]),t("span",Ie,"of "+n(p.value),1),t("button",{class:"btn sm",disabled:i.value===p.value,onClick:e[5]||(e[5]=l=>f(i.value+1))},"Next ›",8,Ve),t("button",{class:"btn sm",disabled:i.value===p.value,onClick:e[6]||(e[6]=l=>f(p.value))},"Last »",8,Ae),L.value?(v(),m("div",Fe,"Showing "+n(U.value+1)+"–"+n(K.value)+" of "+n(L.value),1)):M("",!0)])])):M("",!0),t("main",ze,[$.value?(v(),m("p",Oe,"Loading users…")):D.value?(v(),m("p",Re,n(D.value),1)):(v(),m("div",Ge,[t("div",Ke,[t("table",Je,[t("thead",null,[t("tr",null,[e[31]||(e[31]=t("th",{class:"col-avatar"},"Avatar",-1)),t("th",We,[t("button",{class:"th-btn",type:"button",onClick:e[7]||(e[7]=l=>k("alpha"))},[e[25]||(e[25]=N(" Name ",-1)),t("span",{class:"sort","data-active":d.value==="alpha","data-dir":b.value},null,8,je)])]),t("th",qe,[t("button",{class:"th-btn",type:"button",onClick:e[8]||(e[8]=l=>k("email"))},[e[26]||(e[26]=N(" E-mail ",-1)),t("span",{class:"sort","data-active":d.value==="email","data-dir":b.value},null,8,He)])]),t("th",Qe,[t("button",{class:"th-btn",type:"button",onClick:e[9]||(e[9]=l=>k("org"))},[e[27]||(e[27]=N(" Org ",-1)),t("span",{class:"sort","data-active":d.value==="org","data-dir":b.value},null,8,Xe)])]),t("th",Ye,[t("button",{class:"th-btn",type:"button",onClick:e[10]||(e[10]=l=>k("role"))},[e[28]||(e[28]=N(" Role ",-1)),t("span",{class:"sort","data-active":d.value==="role","data-dir":b.value},null,8,Ze)])]),t("th",et,[t("button",{class:"th-btn center",type:"button",onClick:e[11]||(e[11]=l=>k("level"))},[e[29]||(e[29]=N(" Levels ",-1)),t("span",{class:"sort","data-active":d.value==="level","data-dir":b.value},null,8,tt)])]),t("th",lt,[t("button",{class:"th-btn",type:"button",onClick:e[12]||(e[12]=l=>k("last"))},[e[30]||(e[30]=N(" Last logged in ",-1)),t("span",{class:"sort","data-active":d.value==="last","data-dir":b.value},null,8,st)])]),e[32]||(e[32]=t("th",{class:"col-actions"},"Actions",-1))])]),t("tbody",null,[(v(!0),m(Y,null,fe(W.value,l=>(v(),m("tr",{key:l.id},[t("td",at,[t("img",{class:"avatar clickable",src:re(l),alt:"Avatar",onError:de,onClick:a=>ne(l.id),title:"Open profile"},null,40,ot)]),t("td",nt,[t("div",it,[t("strong",null,n(l.name||"—"),1)])]),t("td",rt,[t("div",dt,n(l.email||"—"),1)]),t("td",ut,[t("div",vt,n(l.orgName||"—"),1)]),t("td",ct,[t("div",gt,n(l.role||"—"),1)]),t("td",_t,[t("div",mt,[t("div",{class:"level-main",style:ye(ae(V(l)))},n(V(l)),5),t("div",pt,[t("div",{class:"skill s-red",title:"Reading Lv "+(l.reading_level||1)},n(l.reading_level||1),9,ft),t("div",{class:"skill s-green",title:"Writing Lv "+(l.writing_level||1)},n(l.writing_level||1),9,bt),t("div",{class:"skill s-blue",title:"Listening Lv "+(l.listening_level||1)},n(l.listening_level||1),9,ht)])])]),t("td",yt,[t("div",kt,n(ve(l.last_seen,l.created_at)),1)]),t("td",wt,[t("button",{class:"btn danger sm",onClick:a=>ue(l),disabled:G.value,title:"Delete account"}," Delete account ",8,xt)])]))),128)),W.value.length===0?(v(),m("tr",Ct,[...e[33]||(e[33]=[t("td",{colspan:"8",class:"muted center"},"No users found.",-1)])])):M("",!0)])])]),t("div",Mt,[t("div",Nt,[t("button",{class:"btn sm",disabled:i.value===1,onClick:e[13]||(e[13]=l=>f(1))},"« First",8,St),t("button",{class:"btn sm",disabled:i.value===1,onClick:e[14]||(e[14]=l=>f(i.value-1))},"‹ Prev",8,$t),e[34]||(e[34]=t("span",{class:"muted"},"Page",-1)),O(t("input",{class:"page-input",type:"number",min:1,max:p.value,"onUpdate:modelValue":e[15]||(e[15]=l=>w.value=l),onChange:j},null,40,Dt),[[ee,w.value,void 0,{number:!0}]]),t("span",Lt,"of "+n(p.value),1),t("button",{class:"btn sm",disabled:i.value===p.value,onClick:e[16]||(e[16]=l=>f(i.value+1))},"Next ›",8,Pt),t("button",{class:"btn sm",disabled:i.value===p.value,onClick:e[17]||(e[17]=l=>f(p.value))},"Last »",8,Ut),L.value?(v(),m("div",Tt,"Showing "+n(U.value+1)+"–"+n(K.value)+" of "+n(L.value),1)):M("",!0)])])]))])],64)):(v(),m("div",Ce,[...e[18]||(e[18]=[t("h2",null,"Forbidden",-1),t("p",null,"This page is only available to developers.",-1)])])),(v(),X(he,{to:"body"},[A.value&&F.value?(v(),X(be,{key:0,open:A.value,"user-id":F.value,onClose:ie},null,8,["open","user-id"])):M("",!0)]))]))}}),Vt=ke(Bt,[["__scopeId","data-v-95955fa7"]]);export{Vt as default};
