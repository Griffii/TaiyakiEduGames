import{d as ze,c as B,W as He,r as o,Q as Xe,o as Ye,g as Qe,a as r,b as a,B as D,p as w,K as Ze,F as ke,h as Te,e as $,t as A,n as ue,u as et,f as u,_ as tt}from"./index-CxPuBSkI.js";import{b as ce,i as at,a as nt,c as st,s as ot}from"./on-the-beat-DLHddV1m.js";import{i as lt}from"./megaphone-Cs9AbUGH.js";import{h as de}from"./home-icon-CTPXHMtR.js";const it=["src"],rt=["src"],ut=["src"],ct=["src"],dt=["src"],vt={key:0,class:"menu","aria-label":"On The Beat menu"},mt={class:"menu-grid"},ht={class:"menu-card"},ft={class:"menu-card__row"},bt=["disabled","onClick"],gt={class:"menu-card"},_t={class:"menu-card__row"},pt={class:"menu-card"},yt={class:"menu-card__row"},wt={class:"menu-card menu-card--start"},Mt=["disabled"],St={key:0,class:"menu-warn"},kt={key:1,class:"game","aria-label":"On The Beat game"},Tt={class:"hud","aria-label":"Game HUD"},xt={class:"hud-center"},Ct={class:"hud-pill hud-pill--round"},Bt={class:"board","aria-label":"Card board"},At={key:0,class:"finish-center","aria-label":"Finish"},Et={key:1,class:"card-grid",role:"grid","aria-label":"8 cards"},Ft={class:"beat-card__inner"},It={key:0,class:"beat-card__jp"},Pt={class:"beat-card__img-wrap"},Nt=["src"],Rt={class:"beat-card__text"},Dt={key:0,class:"beat-card__en"},$t={key:0,class:"overlay overlay--loading",role:"status","aria-live":"polite"},qt={class:"overlay-card"},Ot={class:"overlay-progress"},Lt={class:"bar"},Ut={class:"pct"},Gt={key:1,class:"overlay overlay--countdown",role:"status","aria-live":"polite"},jt={class:"countdown-card"},Kt={class:"countdown-num"},xe="eitake.onthebeat.transit.v1",ve=8,me=5,Y=16,Ce=30,Vt=.88,Be=520,Jt=ze({__name:"OnTheBeatFlashcards",props:{cards:{}},setup(Ae){const Ee=B(()=>({"--otb-bg-url":`url("${ce}")`})),Q=lt,Z=at,ee=nt,te=st,Fe=et(),ae=He(),he=Ae,ne=B(()=>he.cards?.length?he.cards:ae.cards),q=o("menu"),m=o(8),fe=o("normal"),O=o(!0),L=o(!1),f=o([]),se=B(()=>f.value.length>=3),be=B(()=>f.value.length),U=B(()=>Math.min(8,be.value));function Ie(t){t>U.value||(m.value=t)}Xe(be,t=>{if(t>=3){const e=Math.min(Math.max(m.value,3),U.value);e!==m.value&&(m.value=e)}else m.value=3},{immediate:!0});const c=o("idle"),oe=o(0),k=o(3),G=o(Ce),Pe=B(()=>{const t=Math.round(G.value*1e3/me);return Math.max(80,Math.round(t/Y*Vt))}),E=o(0),le=o(0),h=o(-1),T=o([]),b=o(0),M=o(!1),F=o(!0),S=o(!1),x=o(!1),j=o(!1);function Ne(t){const e=Math.PI*2*t/8,n=Math.cos(e),s=Math.sin(e),p=130,v=120,l=(t%2===0?1:-1)*(18+t*2);return{"--dx":`${(n*p).toFixed(1)}vw`,"--dy":`${(s*v).toFixed(1)}vh`,"--rot":`${l}deg`,"--sc":`${1.03}`,animationDuration:`${Be}ms`}}let K=null,d=null,g=null,I=null,P=0,V=null,J=null,N=null;function Re(){try{Fe.back()}catch{}}function De(t){for(let e=t.length-1;e>0;e--){const n=Math.floor(Math.random()*(e+1));[t[e],t[n]]=[t[n],t[e]]}return t}function $e(t,e){const n=De([...t]);return n.slice(0,Math.min(e,n.length))}function ge(t,e,n){return Math.max(e,Math.min(n,t))}function qe(t){return t?.japanese?.kanji??""}function _(t){return new Promise(e=>{if(!t)return e();const n=new Image;n.decoding="async",n.loading="eager",n.onload=()=>e(),n.onerror=()=>e(),n.src=t})}async function _e(){if(K)return K;const t=window.AudioContext||window.webkitAudioContext;return K=new t,K}async function Oe(t){const e=await _e(),s=await(await fetch(t,{cache:"force-cache"})).arrayBuffer();return await e.decodeAudioData(s)}function Le(){try{const t={cards:f.value};sessionStorage.setItem(xe,JSON.stringify(t))}catch{}}function Ue(){try{const t=sessionStorage.getItem(xe);if(!t)return;const e=JSON.parse(t);Array.isArray(e?.cards)&&e.cards.length&&ae.set({cards:e.cards})}catch{}}function pe(t,e){if(e>=4)return t;const n=t.length,s=e*2%n,p=t[s],v=t[(s+1)%n];return[p,v].filter(Boolean)}function ye(t){const e=[];for(let n=0;n<8;n++){const s=t[Math.floor(Math.random()*t.length)];e.push({...s,_slotKey:`${Date.now()}-${Math.random().toString(16).slice(2)}-${n}`})}return e}function we(t,e){const n=pe(t,e);T.value=ye(n),T.value.forEach(s=>void _(s.image_url))}function Ge(t){if(t<8){h.value=-1;return}const e=t-8;h.value=e>=0&&e<8?e:-1}function W(){J!=null&&(window.clearTimeout(J),J=null),N!=null&&(window.clearTimeout(N),N=null),V!=null&&(window.clearTimeout(V),V=null)}function ie(){E.value=0,le.value=0,h.value=-1,b.value=0,M.value=!1,F.value=!0,S.value=!1,x.value=!1,j.value=!1}function z(){try{g&&g.stop()}catch{}g=null,I=null,P=0}function je(){W(),z(),ie(),T.value=[],c.value="idle",q.value="menu"}function Ke(){W(),z(),ie(),T.value=[],c.value="idle",q.value="menu"}function H(){x.value||j.value||(c.value="finished",h.value=-1,M.value=!1,x.value=!0,window.setTimeout(()=>{x.value=!1,T.value=[],j.value=!0},Be+40))}function Me(){W(),H()}function Se(t){const e=Pe.value,n=ve+me*Y,s=()=>{if(c.value!=="countdown"&&c.value!=="playing")return;const v=performance.now()-P,l=Math.max(0,Math.floor(v/e));if(l>=n){H();return}if(M.value=l%2===1,l<ve)return F.value=!0,S.value=!1,b.value=0,h.value=-1,l<2?k.value=3:l<4?k.value=2:l<6?k.value=1:(k.value=0,c.value="playing"),le.value=0,p(l+1,e);F.value=!1,c.value="playing";const y=l-ve,C=Math.floor(y/Y),i=y%Y;return E.value=ge(C,0,me-1),le.value=i,i===0&&(we(t,E.value),h.value=-1,b.value=0),E.value===0&&i<8?(S.value=!0,b.value=i+1,h.value=-1):(S.value=!1,b.value=8,Ge(i)),p(l+1,e)};function p(v,l){const y=P+v*l,C=Math.max(0,y-performance.now());J=window.setTimeout(s,C)}we(t,0),b.value=0,h.value=-1,F.value=!0,S.value=!1,s()}async function Ve(){if(!se.value)return;fe.value="normal",c.value="loading",q.value="game",ie();const t=ge(m.value,3,8),e=$e(f.value,t),n=pe(e,0),s=ye(n),p=[ce,Q,Z,ee,te,de,...f.value.map(R=>R.image_url),...s.map(R=>R.image_url)].filter(Boolean),v=Array.from(new Set(p)),l=v.length+1;let y=0;const C=()=>{y+=1,oe.value=Math.min(1,y/l)};await Promise.all(v.map(async R=>{await _(R),C()}));try{d=await Oe(ot)}catch{d=null}C(),d?.duration&&Number.isFinite(d.duration)&&d.duration>1?G.value=d.duration:G.value=Ce,c.value="countdown",k.value=3;const i=await _e();if(i.state==="suspended"&&await i.resume().catch(()=>{}),z(),!d){P=performance.now()+90,Se(e),N=window.setTimeout(()=>H(),Math.round(G.value*1e3)+900);return}g=i.createBufferSource(),g.buffer=d,I=i.createGain(),I.gain.value=1,g.connect(I),I.connect(i.destination);const X=120,Je=(i.baseLatency??0)+(i.outputLatency??0),re=Math.max(0,Math.round(Je*1e3)),We=i.currentTime+X/1e3;g.start(We),P=performance.now()+X+re,g.onended=()=>Me(),V=window.setTimeout(()=>Me(),Math.round(d.duration*1e3)+X+re+120),Se(e),N=window.setTimeout(()=>{(c.value==="countdown"||c.value==="playing")&&H()},Math.round(d.duration*1e3)+X+re+1200)}return Ye(()=>{ne.value.length||Ue(),f.value=[...ne.value.length?ne.value:ae.cards],Le(),f.value.length>=3?m.value=Math.min(8,f.value.length):m.value=3,_(ce),_(Q),_(Z),_(ee),_(te),_(de)}),Qe(()=>{W(),z()}),(t,e)=>(u(),r("section",{class:"otb-page",style:ue(Ee.value),"aria-label":"On The Beat"},[e[12]||(e[12]=a("div",{class:"otb-bg","aria-hidden":"true"},null,-1)),e[13]||(e[13]=a("div",{class:"otb-bg-overlay","aria-hidden":"true"},null,-1)),a("button",{class:"home-btn",type:"button",onClick:Re,"aria-label":"Back to deck"},[a("img",{src:D(de),alt:""},null,8,it)]),a("img",{class:w(["corner-icon tl corner-icon--mega",{"is-beating":M.value}]),src:D(Q),alt:"","aria-hidden":"true"},null,10,rt),a("img",{class:w(["corner-icon tr",{"is-beating":M.value}]),src:D(Z),alt:"","aria-hidden":"true"},null,10,ut),a("img",{class:w(["corner-icon bl",{"is-beating":M.value}]),src:D(ee),alt:"","aria-hidden":"true"},null,10,ct),a("img",{class:w(["corner-icon br",{"is-beating":M.value}]),src:D(te),alt:"","aria-hidden":"true"},null,10,dt),q.value==="menu"?(u(),r("section",vt,[e[8]||(e[8]=Ze('<header class="menu-head" data-v-85072b29><div class="title-stack" aria-label="Game title" data-v-85072b29><div class="title-main" data-v-85072b29>Say the word</div><div class="title-sub" data-v-85072b29>on the beat!</div></div><p class="menu-subtitle" data-v-85072b29>A flashcard rhythm game</p></header>',1)),a("div",mt,[a("div",ht,[e[3]||(e[3]=a("div",{class:"menu-card__title"},"Words",-1)),a("div",ft,[(u(),r(ke,null,Te([3,4,5,6,7,8],n=>a("button",{key:n,class:w(["sq-btn",{"is-active":m.value===n,"is-disabled":n>U.value}]),type:"button",disabled:n>U.value,onClick:s=>Ie(n)},A(n),11,bt)),64))])]),a("div",gt,[e[6]||(e[6]=a("div",{class:"menu-card__title"},"Speed",-1)),a("div",_t,[e[4]||(e[4]=a("button",{class:"sq-btn",type:"button",disabled:"",title:"Placeholder"},"Slow",-1)),a("button",{class:"sq-btn is-active",type:"button",onClick:e[0]||(e[0]=n=>fe.value="normal")},"Normal"),e[5]||(e[5]=a("button",{class:"sq-btn",type:"button",disabled:"",title:"Placeholder"},"Fast",-1))])]),a("div",pt,[e[7]||(e[7]=a("div",{class:"menu-card__title"},"Card Text",-1)),a("div",yt,[a("button",{class:w(["sq-btn",{"is-active":O.value}]),type:"button",onClick:e[1]||(e[1]=n=>O.value=!O.value)}," English ",2),a("button",{class:w(["sq-btn",{"is-active":L.value}]),type:"button",onClick:e[2]||(e[2]=n=>L.value=!L.value)}," Japanese ",2)])]),a("div",wt,[a("button",{class:"sq-btn sq-btn--primary",type:"button",disabled:!se.value,onClick:Ve}," Start ",8,Mt),se.value?$("",!0):(u(),r("div",St,"This deck has fewer than 3 cards. Add more cards to play."))])])])):(u(),r("section",kt,[a("header",Tt,[a("div",xt,[a("div",Ct,"Round "+A(E.value+1),1)]),a("div",{class:"hud-right"},[a("button",{class:"sq-btn",type:"button",onClick:je},"Stop")])]),a("div",Bt,[j.value?(u(),r("div",At,[a("button",{class:"sq-btn sq-btn--primary",type:"button",onClick:Ke},"Finish")])):(u(),r("div",Et,[(u(!0),r(ke,null,Te(T.value,(n,s)=>(u(),r("article",{key:n._slotKey,class:w(["beat-card",[F.value?"deal-hidden":"",S.value&&s<b.value?"deal-in":"",S.value&&s>=b.value?"deal-hidden":"",x.value?"explode-out":"",h.value===s?"is-highlighted":""]]),role:"gridcell",style:ue(x.value?Ne(s):void 0)},[a("div",Ft,[L.value?(u(),r("div",It,A(qe(n)),1)):$("",!0),a("div",Pt,[n.image_url?(u(),r("img",{key:0,class:"beat-card__img",src:n.image_url,alt:"",decoding:"async"},null,8,Nt)):$("",!0)]),a("div",Rt,[O.value?(u(),r("div",Dt,A(n.english??""),1)):$("",!0)])])],6))),128))]))]),c.value==="loading"?(u(),r("div",$t,[a("div",qt,[e[9]||(e[9]=a("div",{class:"overlay-title"},"Loadingâ€¦",-1)),e[10]||(e[10]=a("div",{class:"overlay-sub"},"Preparing images and audio.",-1)),a("div",Ot,[a("div",Lt,[a("div",{class:"bar__fill",style:ue({width:`${Math.round(oe.value*100)}%`})},null,4)]),a("div",Ut,A(Math.round(oe.value*100))+"%",1)])])])):c.value==="countdown"?(u(),r("div",Gt,[a("div",jt,[a("div",Kt,A(k.value),1),e[11]||(e[11]=a("div",{class:"countdown-sub"},"Get ready",-1))])])):$("",!0)]))],4))}}),Yt=tt(Jt,[["__scopeId","data-v-85072b29"]]);export{Yt as default};
