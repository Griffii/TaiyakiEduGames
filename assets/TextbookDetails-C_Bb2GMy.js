import{d as tt,c as U,A as et,r as k,o as st,Q as ot,k as rt,a,b as o,e as _,t as d,y as M,F as S,h as T,s as f,f as i,m as $,l as B,u as nt,_ as at}from"./index-D3ut4Aj4.js";const L="/TaiyakiEduGames/assets/GriffiiLogo-DYYQtdpP.png",it={class:"page"},lt={class:"content"},ct={key:0,class:"muted"},ut={key:1,class:"error"},dt={key:2,class:"tb-head"},_t={class:"cover-wrap"},vt=["src","data-key","alt"],mt={class:"tb-meta"},ht={class:"tb-title"},kt={class:"tb-sub"},ft={key:0},gt={class:"tb-counts chips"},bt={class:"chip"},pt={class:"chip"},yt={key:0,class:"chips"},wt={key:3,class:"section"},xt={key:0,class:"grid grid--activities"},St=["onClick","onKeydown"],Tt={class:"thumb-wrap"},Ct=["src","data-key","alt"],At={class:"deck-top"},qt={class:"deck-title"},Dt={key:0,class:"chips small"},Ut={key:0,class:"chip more"},Et={key:1,class:"muted"},Ft={key:4,class:"section"},Nt={key:0,class:"grid grid--decks"},Kt=["onClick","onKeydown"],Mt={class:"thumb-wrap deck-thumb-wrap"},$t=["src","data-key","alt"],Bt={class:"deck-top"},Lt={class:"deck-title"},Pt={class:"deck-sub"},zt={class:"pill"},Vt={key:1,class:"muted"},Gt=tt({__name:"TextbookDetails",setup(jt){const P=et(),E=nt(),g=U(()=>String(P.params.id??"")),b=k(!1),v=k(null),u=k(null),p=k([]),C=k([]),w=k(new Map),y=k(null),x=L,m=L,z=U(()=>y.value?.deck_count??p.value.length),V=U(()=>{if(typeof y.value?.unique_card_count=="number")return y.value.unique_card_count;let t=0;for(const s of w.value.values())t+=s;return t});function F(t){E.push(`/deck/${t}`)}function N(t){E.push(`/activities/${t}`)}function h(t){return t.replace(/^\/+/,"").replace(/\/{2,}/g,"/").split("/").map(s=>s.trim()).filter(Boolean).join("/")}function A(t,s,e){const r=h(t),{data:n}=f.storage.from("public-assets").getPublicUrl(r,{transform:{width:s,height:e,resize:"cover"}});return n.publicUrl}function q(t){const s=h(t),{data:e}=f.storage.from("public-assets").getPublicUrl(s);return e.publicUrl}function G(t){return t.cover_image_url&&A(t.cover_image_url,360,504)||x}function j(t){const s=t.target;s.onerror=null;const e=s.dataset.key||"";s.src=e&&q(e)||x}function I(t){return t.thumbnail_url&&A(t.thumbnail_url,300,300)||m}function Q(t){const s=t.target;s.onerror=null;const e=s.dataset.key||"";s.src=e&&q(e)||m}function R(t){return t.thumbnail_url&&A(t.thumbnail_url,300,300)||m}function Y(t){const s=t.target;s.onerror=null;const e=s.dataset.key||"";s.src=e&&q(e)||m}function H(t){return w.value.get(t)??0}st(K),ot(g,K);async function K(){await rt(async()=>{if(!g.value){v.value="Missing textbook id.";return}try{b.value=!0,v.value=null,await J(),await Promise.all([O(),W()]),await Promise.all([X(),Z()])}catch(t){console.error("[TextbookDetails] load failed:",t),v.value=t?.message??String(t)}finally{b.value=!1}},150)}async function J(){const{data:t,error:s}=await f.from("textbooks").select("id, slug, title, year, series, tags, cover_image_url").eq("id",g.value).is("archived_at",null).single();if(s)throw s;t?.cover_image_url&&(t.cover_image_url=h(String(t.cover_image_url))),u.value=t}async function O(){const{data:t,error:s}=await f.from("textbook_decks").select("deck:decks(id, title, slug, thumbnail_url, archived_at)").eq("textbook_id",g.value);if(s)throw s;const e=[];for(const n of t??[]){const c=n.deck,D=Array.isArray(c)?c:c?[c]:[];for(const l of D)!l||l.archived_at||e.push({id:String(l.id),title:String(l.title),slug:String(l.slug),thumbnail_url:l.thumbnail_url?h(String(l.thumbnail_url)):null})}const r=new Set;p.value=e.filter(n=>r.has(n.id)?!1:(r.add(n.id),!0)).sort((n,c)=>n.title.localeCompare(c.title))}async function W(){const{data:t,error:s}=await f.from("textbook_activities").select("activity:activities(id, name, slug, thumbnail_url, tags, archived_at)").eq("textbook_id",g.value);if(s)throw s;const e=[];for(const n of t??[]){const c=n.activity,D=Array.isArray(c)?c:c?[c]:[];for(const l of D)!l||l.archived_at||e.push({id:String(l.id),name:String(l.name),slug:String(l.slug),thumbnail_url:l.thumbnail_url?h(String(l.thumbnail_url)):null,tags:Array.isArray(l.tags)?l.tags:null})}const r=new Set;C.value=e.filter(n=>r.has(n.id)?!1:(r.add(n.id),!0)).sort((n,c)=>n.name.localeCompare(c.name))}async function X(){const{data:t,error:s}=await f.from("v_textbook_deck_card_totals").select("deck_count, unique_card_count").eq("textbook_id",g.value).maybeSingle();if(s){console.warn("[TextbookDetails] totals view missing or errored:",s.message),y.value=null;return}y.value={deck_count:Number(t?.deck_count??0),unique_card_count:Number(t?.unique_card_count??0)}}async function Z(){const t=p.value.map(n=>n.id);if(w.value=new Map,!t.length)return;const{data:s,error:e}=await f.from("deck_card_counts").select("deck_id, unique_card_count").in("deck_id",t);if(e)throw e;const r=new Map;for(const n of t)r.set(n,0);for(const n of s??[])r.set(String(n.deck_id),Number(n.unique_card_count??0));w.value=r}return(t,s)=>(i(),a("div",it,[o("main",lt,[b.value?(i(),a("p",ct,"Loading textbookâ€¦")):_("",!0),v.value?(i(),a("p",ut,d(v.value),1)):_("",!0),!b.value&&!v.value&&u.value?(i(),a("section",dt,[o("div",_t,[o("img",{class:"cover",src:G(u.value),"data-key":u.value?.cover_image_url?h(u.value.cover_image_url):"",alt:u.value.title,referrerpolicy:"no-referrer",onError:s[0]||(s[0]=e=>j(e))},null,40,vt)]),o("div",mt,[o("h2",ht,d(u.value.title),1),o("p",kt,[u.value.year?(i(),a("span",ft,d(u.value.year),1)):_("",!0)]),o("div",gt,[o("span",bt,[o("strong",null,d(z.value),1),s[3]||(s[3]=M(" decks",-1))]),o("span",pt,[o("strong",null,d(V.value),1),s[4]||(s[4]=M(" cards",-1))])]),u.value.tags?.length?(i(),a("div",yt,[(i(!0),a(S,null,T(u.value.tags,e=>(i(),a("span",{class:"chip",key:e},d(e),1))),128))])):_("",!0)])])):_("",!0),!b.value&&!v.value?(i(),a("section",wt,[s[5]||(s[5]=o("div",{class:"section-head"},[o("h3",{class:"section-title"},"Activities")],-1)),C.value.length?(i(),a("div",xt,[(i(!0),a(S,null,T(C.value,e=>(i(),a("button",{key:e.id,class:"activity-card",type:"button",onClick:r=>N(e.slug),onKeydown:$(B(r=>N(e.slug),["prevent"]),["enter"])},[o("div",Tt,[o("img",{class:"thumb",src:R(e),"data-key":e.thumbnail_url?h(e.thumbnail_url):"",alt:e.name,referrerpolicy:"no-referrer",onError:s[1]||(s[1]=r=>Y(r))},null,40,Ct)]),o("div",At,[o("strong",qt,d(e.name),1)]),e.tags?.length?(i(),a("div",Dt,[(i(!0),a(S,null,T(e.tags.slice(0,3),r=>(i(),a("span",{class:"chip",key:r},d(r),1))),128)),e.tags.length>3?(i(),a("span",Ut,"+"+d(e.tags.length-3),1)):_("",!0)])):_("",!0)],40,St))),128))])):(i(),a("p",Et,"No activities linked to this textbook yet."))])):_("",!0),!b.value&&!v.value?(i(),a("section",Ft,[s[6]||(s[6]=o("div",{class:"section-head"},[o("h3",{class:"section-title"},"Decks")],-1)),p.value.length?(i(),a("div",Nt,[(i(!0),a(S,null,T(p.value,e=>(i(),a("div",{key:e.id,class:"deck-card",onClick:r=>F(e.id),role:"button",tabindex:"0",onKeydown:$(B(r=>F(e.id),["prevent"]),["enter"])},[o("div",Mt,[o("img",{class:"thumb deck-thumb",src:I(e),"data-key":e.thumbnail_url?h(e.thumbnail_url):"",alt:e.title,referrerpolicy:"no-referrer",onError:s[2]||(s[2]=r=>Q(r))},null,40,$t)]),o("div",Bt,[o("strong",Lt,d(e.title),1)]),o("div",Pt,[o("span",zt,d(H(e.id))+" cards",1)])],40,Kt))),128))])):(i(),a("p",Vt,"No decks linked to this textbook yet."))])):_("",!0)])]))}}),Qt=at(Gt,[["__scopeId","data-v-4c04f727"]]);export{Qt as default};
