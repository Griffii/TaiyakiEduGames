import{i as U,r as _,N as q,c as $,j as E,A as N,a,d as r,t as c,F as A,e as H,b as o,C as P,v as F,h as k,p as I,R as M,s as p,_ as R}from"./index-3MvJemfc.js";const V={class:"page"},j={class:"content"},z={key:0,class:"muted"},D={key:1,class:"error"},J={key:2,class:"muted"},K={key:3,class:"grid","aria-label":"Textbook list"},O={class:"cover-wrap"},G=["src","alt","onError"],Q={key:1,class:"cover-fallback"},W={class:"cover-title"},X={class:"chips br"},Y={key:0,class:"chip"},Z={key:1,class:"chip"},ee={class:"meta"},te={class:"t"},se={key:0,class:"s"},oe={key:1,class:"s year"},ae={class:"s level"},ne="public-assets",re=U({__name:"TextbookList",setup(ce){const v=_(!0),l=_(null),h=_([]),g=_(!1),f=q(new Set),x=t=>f.has(t),w=t=>f.add(t);function S(t){return!!t&&/^https?:\/\//i.test(t)}function b(t){const{data:s}=p.storage.from(ne).getPublicUrl(t);return s?.publicUrl||""}function m(t){const s=t.cover_image_url||"";return s?S(s)?s:b(String(s)):""}function y(t){return t.series?String(t.series):""}function T(t){const s=(t.tags||[]).map(e=>String(e).toUpperCase().trim());return s.includes("ES")?"å°å­¦æ ¡":s.includes("JHS")?"ä¸­å­¦æ ¡":s.includes("HS")?"é«˜æ ¡":"ä»–"}const B=$(()=>{const t=[...h.value],s=(e,i)=>{const u=`${e.series||""}${e.year||""}${e.title}`,n=`${i.series||""}${i.year||""}${i.title}`;return u.localeCompare(n,void 0,{numeric:!0})};return t.sort(s),t});async function C(){v.value=!0,l.value=null;try{const{data:t,error:s}=await p.from("textbooks").select("id, title, slug, series, year, tags, cover_image_url").order("title",{ascending:!0});if(s)throw s;const{data:e,error:i}=await p.from("v_textbook_deck_card_totals").select("textbook_id, deck_count, unique_card_count");if(i)throw i;const u=new Map;for(const n of e||[]){const d=n.textbook_id??n.id??n.textbook_uuid;d&&u.set(String(d),{deck_count:n.deck_count??null,unique_card_count:n.unique_card_count??null})}h.value=(t||[]).map(n=>{const d=u.get(n.id)||{deck_count:null,unique_card_count:null};return{...n,...d}})}catch(t){l.value=t?.message??String(t)}finally{v.value=!1}}async function L(){const{data:t}=await p.auth.getSession();g.value=!!t.session}return E(async()=>{await N(async()=>{await Promise.all([C(),L()])},150)}),(t,s)=>(o(),a("div",V,[s[0]||(s[0]=r("header",{class:"head"},[r("div",{class:"head-inner"},[r("div",{class:"head-text"})])],-1)),r("main",j,[v.value?(o(),a("p",z,"Loading textbooksâ€¦")):l.value?(o(),a("p",D,c(l.value),1)):h.value.length===0?(o(),a("p",J,"No textbooks found.")):(o(),a("section",K,[(o(!0),a(A,null,H(B.value,e=>(o(),P(I(M),{key:e.id,class:"card",role:"listitem",to:{name:"textbook_details",params:{id:e.id}},title:e.title},{default:F(()=>[r("div",O,[!x(e.id)&&m(e)?(o(),a("img",{key:0,class:"cover",src:m(e),alt:e.title,loading:"lazy",decoding:"async",onError:()=>w(e.id)},null,40,G)):(o(),a("div",Q,[r("span",W,c(e.title),1)])),r("div",X,[typeof e.deck_count=="number"?(o(),a("span",Y," ğŸ“š "+c(e.deck_count),1)):k("",!0),typeof e.unique_card_count=="number"?(o(),a("span",Z," ğŸƒ "+c(e.unique_card_count),1)):k("",!0)])]),r("div",ee,[r("div",te,c(e.title),1),y(e)?(o(),a("div",se,c(y(e)),1)):k("",!0),e.year?(o(),a("div",oe,c(e.year),1)):k("",!0),r("div",ae,c(T(e)),1)])]),_:2},1032,["to","title"]))),128))]))])]))}}),le=R(re,[["__scopeId","data-v-62fb14af"]]);export{le as T};
