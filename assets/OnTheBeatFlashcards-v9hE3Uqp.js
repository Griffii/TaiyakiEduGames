import{d as st,c as P,W as ot,r as i,Q as lt,o as it,g as rt,a as d,b as n,B as J,p as h,K as ut,F as De,h as Fe,e as W,t as $,n as ye,u as ct,f as v,_ as dt}from"./index-uE9vU5U9.js";import{b as we,i as vt,a as mt,c as ft,s as ht}from"./on-the-beat-DLHddV1m.js";import{i as gt}from"./megaphone-Cs9AbUGH.js";import{h as Me}from"./home-icon-CTPXHMtR.js";const bt=["src"],pt=["src"],_t=["src"],yt=["src"],wt=["src"],Mt={key:0,class:"menu","aria-label":"On The Beat menu"},St={class:"menu-grid"},Tt={class:"menu-card"},kt={class:"menu-card__row"},Bt=["disabled","onClick"],Et={class:"menu-card"},xt={class:"menu-card__row"},Ct={class:"menu-card"},At={class:"menu-card__row"},Rt={class:"menu-card menu-card--start"},Pt=["disabled"],It={key:0,class:"menu-warn"},Ut={key:1,class:"game","aria-label":"On The Beat game"},Dt={class:"hud","aria-label":"Game HUD"},Ft={class:"hud-center"},Nt={class:"hud-pill hud-pill--round"},$t={class:"board","aria-label":"Card board"},qt={key:0,class:"finish-center","aria-label":"Finish"},Lt={key:1,class:"card-grid",role:"grid","aria-label":"8 cards"},Ot={class:"beat-card__inner"},Gt={key:0,class:"beat-card__jp"},jt={class:"beat-card__img-wrap"},Kt=["src"],Vt={class:"beat-card__text"},Jt={key:0,class:"beat-card__en"},Wt={key:0,class:"overlay overlay--loading",role:"status","aria-live":"polite"},Xt={class:"overlay-card"},Yt={class:"overlay-progress"},zt={class:"bar"},Ht={class:"pct"},Qt={key:1,class:"overlay overlay--countdown",role:"status","aria-live":"polite"},Zt={class:"countdown-card"},ea={class:"countdown-num"},Ne="eitake.onthebeat.transit.v1",X=.96,Se=.03,re=1.12,q=8,ue=5,I=16,$e=30,ta=.875,qe=100,Le=520,aa=st({__name:"OnTheBeatFlashcards",props:{cards:{}},setup(Oe){const Ge=P(()=>({"--otb-bg-url":`url("${we}")`})),ce=gt,de=vt,ve=mt,me=ft,je=ct(),fe=ot(),Te=Oe,he=P(()=>Te.cards?.length?Te.cards:fe.cards),Y=i("menu"),b=i(8),r=i("normal"),z=i(!0),H=i(!1),ke={slow:.92,normal:1,fast:1.08},Ke=P(()=>{if(r.value!=="speedingUp")return 1;const t=S(E.value,0,4);return S(X+t*Se,.75,re)}),Be=P(()=>r.value==="speedingUp"?Ke.value:ke[r.value]??1),y=i([]),ge=P(()=>y.value.length>=3),Ee=P(()=>y.value.length),Q=P(()=>Math.min(8,Ee.value));function Ve(t){t>Q.value||(b.value=t)}lt(Ee,t=>{if(t>=3){const e=Math.min(Math.max(b.value,3),Q.value);e!==b.value&&(b.value=e)}else b.value=3},{immediate:!0});const m=i("idle"),be=i(0),U=i(3),L=i($e);function xe(t){const e=Math.round(L.value*1e3/ue),a=Math.max(80,Math.round(e/I*ta));return Math.max(40,Math.round(a/t))}const E=i(0),pe=i(0),p=i(-1),D=i([]),w=i(0),x=i(!1),O=i(!0),C=i(!1),F=i(!1),Z=i(!1);function Je(t){const e=Math.PI*2*t/8,a=Math.cos(e),l=Math.sin(e),k=130,_=120,A=(t%2===0?1:-1)*(18+t*2);return{"--dx":`${(a*k).toFixed(1)}vw`,"--dy":`${(l*_).toFixed(1)}vh`,"--rot":`${A}deg`,"--sc":`${1.03}`,animationDuration:`${Le}ms`}}let ee=null,M=null,f=null,G=null,j=0,te=null,ae=null,K=null;function We(){try{je.back()}catch{}}function Xe(t){for(let e=t.length-1;e>0;e--){const a=Math.floor(Math.random()*(e+1));[t[e],t[a]]=[t[a],t[e]]}return t}function Ye(t,e){const a=Xe([...t]);return a.slice(0,Math.min(e,a.length))}function S(t,e,a){return Math.max(e,Math.min(a,t))}function ze(t){return t?.japanese?.kanji??""}function T(t){return new Promise(e=>{if(!t)return e();const a=new Image;a.decoding="async",a.loading="eager",a.onload=()=>e(),a.onerror=()=>e(),a.src=t})}async function Ce(){if(ee)return ee;const t=window.AudioContext||window.webkitAudioContext;return ee=new t,ee}async function He(t){const e=await Ce(),l=await(await fetch(t,{cache:"force-cache"})).arrayBuffer();return await e.decodeAudioData(l)}function Qe(){try{const t={cards:y.value};sessionStorage.setItem(Ne,JSON.stringify(t))}catch{}}function Ze(){try{const t=sessionStorage.getItem(Ne);if(!t)return;const e=JSON.parse(t);Array.isArray(e?.cards)&&e.cards.length&&fe.set({cards:e.cards})}catch{}}function Ae(t,e){if(e>=4)return t;const a=t.length,l=e*2%a,k=t[l],_=t[(l+1)%a];return[k,_].filter(Boolean)}function Re(t){const e=[];for(let a=0;a<8;a++){const l=t[Math.floor(Math.random()*t.length)];e.push({...l,_slotKey:`${Date.now()}-${Math.random().toString(16).slice(2)}-${a}`})}return e}function Pe(t,e){const a=Ae(t,e);D.value=Re(a),D.value.forEach(l=>void T(l.image_url))}function et(t){if(t<8){p.value=-1;return}const e=t-8;p.value=e>=0&&e<8?e:-1}function ne(){ae!=null&&(window.clearTimeout(ae),ae=null),K!=null&&(window.clearTimeout(K),K=null),te!=null&&(window.clearTimeout(te),te=null)}function _e(){E.value=0,pe.value=0,p.value=-1,w.value=0,x.value=!1,O.value=!0,C.value=!1,F.value=!1,Z.value=!1}function se(){try{f&&f.stop()}catch{}f=null,G=null,j=0}function tt(){ne(),se(),_e(),D.value=[],m.value="idle",Y.value="menu"}function at(){ne(),se(),_e(),D.value=[],m.value="idle",Y.value="menu"}function oe(){F.value||Z.value||(m.value="finished",p.value=-1,x.value=!1,F.value=!0,window.setTimeout(()=>{F.value=!1,D.value=[],Z.value=!0},Le+40))}function Ie(){ne(),oe()}function Ue(t){const e=q+ue*I,a=[],l=r.value==="speedingUp"?X:Be.value,k=xe(l);a.push({beats:q,intervalMs:k,startBeat:0,startTimeMs:0,rate:l});let _=q,A=q*k;for(let u=0;u<ue;u++){const s=r.value==="speedingUp"?S(X+u*Se,.75,re):Be.value,o=xe(s);a.push({beats:I,intervalMs:o,startBeat:_,startTimeMs:A,rate:s}),_+=I,A+=I*o}const V=A;function le(u){if(u<=0)return 0;for(let s=0;s<a.length;s++){const o=a[s],B=o.startTimeMs+o.beats*o.intervalMs;if(u<B){const c=Math.floor((u-o.startTimeMs)/o.intervalMs);return S(o.startBeat+c,o.startBeat,o.startBeat+o.beats-1)}}return e}function g(u){for(let s=a.length-1;s>=0;s--){const o=a[s];if(u>=o.startBeat)return o}return a[0]}const ie=()=>{if(m.value!=="countdown"&&m.value!=="playing")return;const u=performance.now()-j,s=le(u);if(s>=e){oe();return}if(x.value=s%2===1,s<q)return O.value=!0,C.value=!1,w.value=0,p.value=-1,s<2?U.value=3:s<4?U.value=2:s<6?U.value=1:(U.value=0,m.value="playing"),pe.value=0,R(s+1);O.value=!1,m.value="playing";const o=s-q,B=Math.floor(o/I),c=o%I;if(E.value=S(B,0,ue-1),pe.value=c,r.value==="speedingUp"&&f){const N=S(X+E.value*Se,.75,re);Math.abs(f.playbackRate.value-N)>.001&&(f.playbackRate.value=N)}return c===0&&(Pe(t,E.value),p.value=-1,w.value=0),E.value===0&&c<8?(C.value=!0,w.value=c+1,p.value=-1):(C.value=!1,w.value=8,et(c)),R(s+1)};function R(u){const s=g(u),o=u-s.startBeat,B=s.startTimeMs+o*s.intervalMs,c=j+B,N=Math.max(0,c-performance.now());ae=window.setTimeout(ie,N)}return Pe(t,0),w.value=0,p.value=-1,O.value=!0,C.value=!1,ie(),V}async function nt(){if(!ge.value)return;m.value="loading",Y.value="game",_e();const t=S(b.value,3,8),e=Ye(y.value,t),a=Ae(e,0),l=Re(a),k=[we,ce,de,ve,me,Me,...y.value.map(c=>c.image_url),...l.map(c=>c.image_url)].filter(Boolean),_=Array.from(new Set(k)),A=_.length+1;let V=0;const le=()=>{V+=1,be.value=Math.min(1,V/A)};await Promise.all(_.map(async c=>{await T(c),le()}));try{M=await He(ht)}catch{M=null}le(),M?.duration&&Number.isFinite(M.duration)&&M.duration>1?L.value=M.duration:L.value=$e,m.value="countdown",U.value=3;const g=await Ce();g.state==="suspended"&&await g.resume().catch(()=>{}),se();const ie=r.value==="speedingUp"?S(X,.75,re):ke[r.value]??1;if(!M){j=performance.now()+90+qe;const N=Ue(e)??Math.round(L.value*1e3);K=window.setTimeout(()=>oe(),Math.round(N)+900);return}f=g.createBufferSource(),f.buffer=M,f.playbackRate.value=ie,G=g.createGain(),G.gain.value=1,f.connect(G),G.connect(g.destination);const R=120,u=(g.baseLatency??0)+(g.outputLatency??0),s=Math.max(0,Math.round(u*1e3)),o=g.currentTime+R/1e3;f.start(o),j=performance.now()+R+s+qe;const B=Ue(e)??Math.round(L.value*1e3);f.onended=()=>Ie(),te=window.setTimeout(()=>Ie(),Math.round(B)+R+s+180),K=window.setTimeout(()=>{(m.value==="countdown"||m.value==="playing")&&oe()},Math.round(B)+R+s+1200)}return it(()=>{he.value.length||Ze(),y.value=[...he.value.length?he.value:fe.cards],Qe(),y.value.length>=3?b.value=Math.min(8,y.value.length):b.value=3,T(we),T(ce),T(de),T(ve),T(me),T(Me)}),rt(()=>{ne(),se()}),(t,e)=>(v(),d("section",{class:"otb-page",style:ye(Ge.value),"aria-label":"On The Beat"},[e[13]||(e[13]=n("div",{class:"otb-bg","aria-hidden":"true"},null,-1)),e[14]||(e[14]=n("div",{class:"otb-bg-overlay","aria-hidden":"true"},null,-1)),n("button",{class:"home-btn",type:"button",onClick:We,"aria-label":"Back to deck"},[n("img",{src:J(Me),alt:""},null,8,bt)]),n("img",{class:h(["corner-icon tl corner-icon--mega",{"is-beating":x.value}]),src:J(ce),alt:"","aria-hidden":"true"},null,10,pt),n("img",{class:h(["corner-icon tr",{"is-beating":x.value}]),src:J(de),alt:"","aria-hidden":"true"},null,10,_t),n("img",{class:h(["corner-icon bl",{"is-beating":x.value}]),src:J(ve),alt:"","aria-hidden":"true"},null,10,yt),n("img",{class:h(["corner-icon br",{"is-beating":x.value}]),src:J(me),alt:"","aria-hidden":"true"},null,10,wt),Y.value==="menu"?(v(),d("section",Mt,[e[9]||(e[9]=ut('<header class="menu-head" data-v-b8e00e50><div class="title-stack" aria-label="Game title" data-v-b8e00e50><div class="title-main" data-v-b8e00e50>Say the word</div><div class="title-sub" data-v-b8e00e50>on the beat!</div></div><p class="menu-subtitle" data-v-b8e00e50>A flashcard rhythm game</p></header>',1)),n("div",St,[n("div",Tt,[e[6]||(e[6]=n("div",{class:"menu-card__title"},"Words",-1)),n("div",kt,[(v(),d(De,null,Fe([3,4,5,6,7,8],a=>n("button",{key:a,class:h(["sq-btn",{"is-active":b.value===a,"is-disabled":a>Q.value}]),type:"button",disabled:a>Q.value,onClick:l=>Ve(a)},$(a),11,Bt)),64))])]),n("div",Et,[e[7]||(e[7]=n("div",{class:"menu-card__title"},"Speed",-1)),n("div",xt,[n("button",{class:h(["sq-btn",{"is-active":r.value==="slow"}]),type:"button",onClick:e[0]||(e[0]=a=>r.value="slow")}," Slow ",2),n("button",{class:h(["sq-btn",{"is-active":r.value==="normal"}]),type:"button",onClick:e[1]||(e[1]=a=>r.value="normal")}," Normal ",2),n("button",{class:h(["sq-btn",{"is-active":r.value==="fast"}]),type:"button",onClick:e[2]||(e[2]=a=>r.value="fast")}," Fast ",2),n("button",{class:h(["sq-btn",{"is-active":r.value==="speedingUp"}]),type:"button",onClick:e[3]||(e[3]=a=>r.value="speedingUp"),title:"Each round gets faster"}," Speeding Up ",2)])]),n("div",Ct,[e[8]||(e[8]=n("div",{class:"menu-card__title"},"Card Text",-1)),n("div",At,[n("button",{class:h(["sq-btn",{"is-active":z.value}]),type:"button",onClick:e[4]||(e[4]=a=>z.value=!z.value)}," English ",2),n("button",{class:h(["sq-btn",{"is-active":H.value}]),type:"button",onClick:e[5]||(e[5]=a=>H.value=!H.value)}," Japanese ",2)])]),n("div",Rt,[n("button",{class:"sq-btn sq-btn--primary",type:"button",disabled:!ge.value,onClick:nt}," Start ",8,Pt),ge.value?W("",!0):(v(),d("div",It,"This deck has fewer than 3 cards. Add more cards to play."))])])])):(v(),d("section",Ut,[n("header",Dt,[n("div",Ft,[n("div",Nt,"Round "+$(E.value+1),1)]),n("div",{class:"hud-right"},[n("button",{class:"sq-btn",type:"button",onClick:tt},"Stop")])]),n("div",$t,[Z.value?(v(),d("div",qt,[n("button",{class:"sq-btn sq-btn--primary",type:"button",onClick:at},"Finish")])):(v(),d("div",Lt,[(v(!0),d(De,null,Fe(D.value,(a,l)=>(v(),d("article",{key:a._slotKey,class:h(["beat-card",[O.value?"deal-hidden":"",C.value&&l<w.value?"deal-in":"",C.value&&l>=w.value?"deal-hidden":"",F.value?"explode-out":"",p.value===l?"is-highlighted":""]]),role:"gridcell",style:ye(F.value?Je(l):void 0)},[n("div",Ot,[H.value?(v(),d("div",Gt,$(ze(a)),1)):W("",!0),n("div",jt,[a.image_url?(v(),d("img",{key:0,class:"beat-card__img",src:a.image_url,alt:"",decoding:"async"},null,8,Kt)):W("",!0)]),n("div",Vt,[z.value?(v(),d("div",Jt,$(a.english??""),1)):W("",!0)])])],6))),128))]))]),m.value==="loading"?(v(),d("div",Wt,[n("div",Xt,[e[10]||(e[10]=n("div",{class:"overlay-title"},"Loadingâ€¦",-1)),e[11]||(e[11]=n("div",{class:"overlay-sub"},"Preparing images and audio.",-1)),n("div",Yt,[n("div",zt,[n("div",{class:"bar__fill",style:ye({width:`${Math.round(be.value*100)}%`})},null,4)]),n("div",Ht,$(Math.round(be.value*100))+"%",1)])])])):m.value==="countdown"?(v(),d("div",Qt,[n("div",Zt,[n("div",ea,$(U.value),1),e[12]||(e[12]=n("div",{class:"countdown-sub"},"Get ready",-1))])])):W("",!0)]))],4))}}),ia=dt(aa,[["__scopeId","data-v-b8e00e50"]]);export{ia as default};
