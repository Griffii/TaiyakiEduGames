import{i as re,r as d,N as ue,j as de,a as r,d as l,h as k,f as K,t as T,F as R,e as ce,g as p,x as S,G as M,y as F,s as D,L,b as u,O as ve,u as fe,_ as pe}from"./index-CzXY4mDr.js";const me={class:"custom-decks-page chalkboard-bg","aria-labelledby":"page-title"},_e={class:"topbar"},ge={class:"actions"},be=["disabled"],ke=["aria-pressed"],ye={key:0,class:"zero"},he={key:1,class:"loading",role:"status","aria-live":"polite"},De=["aria-label"],we=["draggable","aria-grabbed","onDragstart","onDragenter","onDragover","onDrop"],Ce={class:"deck-card"},xe=["aria-label","onClick","onKeydown"],Te={class:"cover"},Ie=["src","onError"],Ee=["data-initial"],Ne={class:"deck-footer"},Re=["title"],Se=["aria-label"],Me={key:0,class:"deck-edit-bar"},Fe={class:"edit-right"},Ue=["onClick"],$e={class:"edit-left"},qe=["onClick"],Ve={class:"edit-right"},Oe=["onClick"],Be={key:3,class:"glass-overlay","aria-hidden":"true"},Pe={class:"modal-body"},Ke={class:"field"},Le={class:"field"},ze={class:"modal-foot"},Ae=["disabled"],je=["disabled"],Ge={class:"modal-card"},Ye={class:"modal-body"},He={class:"modal-foot"},Je=["disabled"],Qe=["disabled"],We={key:6,class:"error",role:"alert"},Xe=re({__name:"CustomDecks",setup(Ze){const z=fe(),i=d([]),m=d({}),c=d(!1),v=d(null),o=d(!1),I=d(!1),f=ue({title:"",description:""}),U=d(null),_=d(null),y=d(""),$=d(null),b=d(null),w=d(null),C=d(null),E=d(null);function x(){window.setTimeout(()=>v.value=null,3e3)}function A(t){const e=t.trim().split(/\s+/);return((e[0]?.[0]||"")+(e[1]?.[0]||"")).toUpperCase()||"D"}async function q(){const{data:t,error:e}=await D.auth.getUser();if(e||!t.user)throw new Error("Not authenticated");return t.user.id}function j(){const t=i.value.reduce((e,a)=>Math.max(e,a.position??0),0);return(isFinite(t)?t:0)+1e3}async function G(){c.value=!0,v.value=null;try{const t=await q(),{data:e,error:a}=await D.from("custom_decks").select("id, owner_user_id, org_id, title, description, visibility, card_count, position, created_at, updated_at").eq("owner_user_id",t).order("position",{ascending:!0,nullsFirst:!0}).order("updated_at",{ascending:!1});if(a)throw a;i.value=e??[],m.value={};const s=i.value.map(n=>n.id);if(s.length>0){const{data:n,error:g}=await D.from("v_custom_deck_random_cover").select("deck_id, image_url").in("deck_id",s);if(g)throw g;(n||[]).forEach(h=>{m.value[h.deck_id]=h?.image_url??void 0}),s.forEach(h=>{h in m.value||(m.value[h]=void 0)})}}catch(t){v.value=t?.message??"Failed to load decks",x()}finally{c.value=!1}}function Y(){o.value=!o.value,o.value||(_.value=null,y.value="",w.value=null,C.value=null,E.value=null)}function V(){I.value=!0,f.title="",f.description="",L(()=>U.value?.focus())}function N(){I.value=!1}async function H(){if(f.title.trim()){c.value=!0,v.value=null;try{const t=await q(),e=crypto.randomUUID(),a={id:e,owner_user_id:t,org_id:null,title:f.title.trim(),description:f.description.trim()||null,visibility:"private",card_count:0,position:j(),created_at:new Date().toISOString(),updated_at:new Date().toISOString()};i.value.unshift(a),m.value[e]=void 0,N();const{data:s,error:n}=await D.from("custom_decks").insert({owner_user_id:t,title:a.title,description:a.description,visibility:"private",position:a.position}).select("id, owner_user_id, org_id, title, description, visibility, card_count, position, created_at, updated_at").single();if(n)throw n;const g=i.value.findIndex(h=>h.id===e);g!==-1&&(i.value[g]=s)}catch(t){i.value=i.value.filter(e=>!(e.id&&e.id.length===36)),v.value=t?.message??"Failed to create deck",x()}finally{c.value=!1}}}function J(t){_.value=t.id,y.value=t.title,L(()=>$.value?.select())}function O(){_.value=null,y.value=""}async function Q(t){const e=y.value.trim();if(!_.value)return;if(!e||e===t.title){O();return}const a=t.title;t.title=e,_.value=null,y.value="";try{const{error:s}=await D.from("custom_decks").update({title:e}).eq("id",t.id);if(s)throw s}catch(s){t.title=a,v.value=s?.message??"Rename failed",x()}}function W(t){b.value=t.id}function B(){b.value=null}async function X(){if(!b.value)return;const t=b.value,e=i.value.slice();i.value=i.value.filter(a=>a.id!==t),delete m.value[t],b.value=null;try{const{error:a}=await D.from("custom_decks").delete().eq("id",t);if(a)throw a}catch(a){i.value=e,v.value=a?.message??"Delete failed",x()}}function Z(t){return!!t?.closest?.('input, textarea, button, [contenteditable="true"], .title-input')}function ee(t,e,a){if(o.value){if(_.value||Z(t.target)){t.preventDefault();return}C.value=e,w.value=a,t.dataTransfer&&(t.dataTransfer.setData("text/plain",String(e)),t.dataTransfer.effectAllowed="move")}}function te(t,e){o.value&&(E.value=e)}function ae(t,e){o.value&&(t.preventDefault(),t.dataTransfer&&(t.dataTransfer.dropEffect="move"))}function le(t,e){if(!o.value)return;t.preventDefault();let a=C.value;if(a==null){const g=t.dataTransfer?.getData("text/plain");g&&!Number.isNaN(Number(g))&&(a=Number(g))}if(C.value=null,E.value=null,w.value=null,a==null||a===e)return;const s=i.value.slice(),[n]=s.splice(a,1);s.splice(e,0,n),i.value=s,se()}function ne(){C.value=null,E.value=null,w.value=null}function ie(t){return(t+1)*1e3}async function se(){try{const t=i.value.map((e,a)=>({id:e.id,position:ie(a)}));i.value=i.value.map((e,a)=>({...e,position:t[a].position})),await Promise.all(t.map(e=>D.from("custom_decks").update({position:e.position}).eq("id",e.id)))}catch(t){console.error(t),v.value="Failed to save new order",x()}}function P(t){z.push({name:"deck",params:{id:t},query:{kind:"custom"}})}function oe(t){m.value[t]=void 0}return de(()=>{G()}),(t,e)=>(u(),r("section",me,[l("header",_e,[e[5]||(e[5]=l("h1",{id:"page-title",class:"title"},"My Custom Decks",-1)),l("div",ge,[l("button",{class:"btn create",type:"button",onClick:V,disabled:c.value},"+ Create",8,be),l("button",{class:K(["btn edit-toggle",{on:o.value}]),type:"button","aria-pressed":o.value,onClick:Y,title:"Toggle Edit Mode"},T(o.value?"Done":"Edit"),11,ke)])]),!c.value&&i.value.length===0?(u(),r("div",ye,[e[6]||(e[6]=l("p",null,"It's empty...",-1)),l("button",{class:"btn primary",type:"button",onClick:V},"Create your first deck")])):k("",!0),c.value?(u(),r("div",he,"Loading…")):k("",!0),!c.value&&i.value.length>0?(u(),r("ul",{key:2,class:"deck-grid",role:"list","aria-label":o.value?"Reorder your decks by dragging":"Your custom decks"},[(u(!0),r(R,null,ce(i.value,(a,s)=>(u(),r("li",{key:a.id,class:K(["deck-item",{dragging:w.value===a.id,draggable:o.value}]),draggable:o.value&&_.value!==a.id,"aria-grabbed":o.value&&w.value===a.id?"true":"false",onDragstart:n=>ee(n,s,a.id),onDragenter:p(n=>te(n,s),["prevent"]),onDragover:p(n=>ae(n),["prevent"]),onDrop:p(n=>le(n,s),["prevent"]),onDragend:ne},[l("div",Ce,[l("div",{class:"deck-click",role:"button",tabindex:"0","aria-label":`Open ${a.title}`,onClick:n=>!o.value&&P(a.id),onKeydown:ve(n=>!o.value&&P(a.id),["enter"])},[l("div",Te,[m.value[a.id]?(u(),r("img",{key:0,class:"cover-img",src:m.value[a.id],alt:"",referrerpolicy:"no-referrer",onError:n=>oe(a.id)},null,40,Ie)):(u(),r("div",{key:1,class:"cover-fallback","data-initial":A(a.title)},null,8,Ee))]),l("div",Ne,[_.value===a.id?S((u(),r("input",{key:0,ref_for:!0,ref_key:"renameInputRef",ref:$,"onUpdate:modelValue":e[0]||(e[0]=n=>y.value=n),maxlength:120,class:"title-input","aria-label":"Deck title",onMousedown:e[1]||(e[1]=p(()=>{},["stop"])),onDragstart:e[2]||(e[2]=p(()=>{},["prevent"]))},null,544)),[[F,y.value]]):(u(),r("div",{key:1,class:"deck-title",title:a.title},T(a.title),9,Re)),l("span",{class:"count-badge","aria-label":`${a.card_count} cards`},T(a.card_count),9,Se)])],40,xe),o.value?(u(),r("div",Me,[_.value===a.id?(u(),r(R,{key:0},[e[7]||(e[7]=l("div",{class:"edit-left"},[l("span",{class:"muted small"},"Editing title…")],-1)),l("div",Fe,[l("button",{class:"btn tiny success",type:"button",onClick:n=>Q(a)},"Save",8,Ue),l("button",{class:"btn tiny cancel",type:"button",onClick:O},"Cancel")])],64)):(u(),r(R,{key:1},[l("div",$e,[l("button",{class:"btn tiny",type:"button",onClick:p(n=>J(a),["stop"])},"Rename",8,qe)]),l("div",Ve,[l("button",{class:"btn tiny danger",type:"button",onClick:p(n=>W(a),["stop"])},"Delete",8,Oe)])],64))])):k("",!0)])],42,we))),128))],8,De)):k("",!0),I.value||b.value?(u(),r("div",Be)):k("",!0),I.value?(u(),r("dialog",{key:4,class:"modal modal-create",open:"",onClick:p(N,["self"])},[l("form",{class:"modal-card",onSubmit:p(H,["prevent"])},[e[10]||(e[10]=l("header",{class:"modal-head"},[l("h3",null,"Create New Deck")],-1)),l("div",Pe,[l("label",Ke,[e[8]||(e[8]=l("span",{class:"label"},[M("Title "),l("span",{class:"req"},"*")],-1)),S(l("input",{ref_key:"createTitleRef",ref:U,class:"input","onUpdate:modelValue":e[3]||(e[3]=a=>f.title=a),maxlength:120,required:"",placeholder:"e.g., Animals – Unit 3 Mix"},null,512),[[F,f.title,void 0,{trim:!0}]])]),l("label",Le,[e[9]||(e[9]=l("span",{class:"label"},"Description",-1)),S(l("textarea",{class:"textarea","onUpdate:modelValue":e[4]||(e[4]=a=>f.description=a),maxlength:500,placeholder:"(optional) Short description",rows:"3"},null,512),[[F,f.description,void 0,{trim:!0}]])])]),l("footer",ze,[l("button",{class:"btn cancel",type:"button",onClick:N,disabled:c.value},"Cancel",8,Ae),l("button",{class:"btn success",type:"submit",disabled:c.value||f.title.length===0},"Create",8,je)])],32)])):k("",!0),b.value?(u(),r("dialog",{key:5,class:"modal modal-delete",open:"",onClick:p(B,["self"])},[l("div",Ge,[e[13]||(e[13]=l("header",{class:"modal-head"},[l("h3",null,"Delete Deck?")],-1)),l("div",Ye,[l("p",null,[e[11]||(e[11]=M(" This will permanently delete ",-1)),l("strong",null,T(i.value.find(a=>a.id===b.value)?.title),1),e[12]||(e[12]=M(". This can’t be undone. ",-1))])]),l("footer",He,[l("button",{class:"btn cancel",type:"button",onClick:B,disabled:c.value},"Cancel",8,Je),l("button",{class:"btn danger",type:"button",onClick:X,disabled:c.value},"Delete",8,Qe)])])])):k("",!0),v.value?(u(),r("p",We,T(v.value),1)):k("",!0)]))}}),tt=pe(Xe,[["__scopeId","data-v-82a5d3ef"]]);export{tt as default};
