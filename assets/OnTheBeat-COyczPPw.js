import{d as Ue,c as C,r as o,o as qe,g as Le,a as i,b as t,B as U,p as _,K as $e,e as le,t as S,F as Ke,h as Ve,n as ie,u as Je,f as u,_ as We}from"./index-ByczhbZr.js";import{b as ue,i as Xe,a as ze,c as He,s as Ye}from"./on-the-beat-DLHddV1m.js";import{i as Qe}from"./megaphone-Cs9AbUGH.js";import{h as re}from"./home-icon-CTPXHMtR.js";const Ze=["src"],et=["src"],tt=["src"],nt=["src"],at=["src"],st={key:0,class:"menu","aria-label":"On The Beat menu"},ot={class:"menu-grid"},lt={class:"menu-card"},it={class:"menu-card__row"},ut={class:"menu-card"},rt={class:"menu-card__row"},ct={class:"menu-play"},dt=["disabled"],vt={key:0,class:"menu-warn"},ht={key:1,class:"game","aria-label":"On The Beat game"},gt={class:"hud","aria-label":"Game HUD"},mt={class:"hud-center"},pt={class:"hud-pill hud-pill--round"},ft={class:"hud-debug","aria-hidden":"true"},_t={class:"hud-pill hud-pill--debug"},bt={class:"board","aria-label":"Card board"},yt={key:0,class:"finish-center","aria-label":"Continue/Finish"},wt={key:1,class:"card-grid",role:"grid","aria-label":"8 cards"},jt={class:"beat-card__inner"},xt={key:0,class:"beat-card__jp"},St={key:1,class:"beat-card__text beat-card__text--center"},Mt={class:"beat-card__en"},Tt={key:2,class:"beat-card__text beat-card__text--spacer","aria-hidden":"true"},kt={key:0,class:"overlay overlay--loading",role:"status","aria-live":"polite"},Bt={class:"overlay-card"},Ct={class:"overlay-progress"},Et={class:"bar"},It={class:"pct"},Nt={key:1,class:"overlay overlay--countdown",role:"status","aria-live":"polite"},Rt={class:"countdown-card"},Ot={class:"countdown-num"},ce=8,de=5,Y=16,fe=30,Pt=.875,_e=520,At=Ue({__name:"OnTheBeat",setup(Ft){const be=Je(),ye=C(()=>({"--otb-bg-url":`url("${ue}")`})),Q=Qe,Z=Xe,ee=ze,te=He,q=o("menu"),E=o("pronouns"),L=o(!0),$=o(!0),r=o("idle"),K=o(0),M=o(3),ne={pronouns:{label:"Pronouns",games:[[[{english:"I",jp:"わたし"},{english:"my",jp:"わたしの"},{english:"me",jp:"わたしを／に"},{english:"mine",jp:"わたしのもの"}],[{english:"you",jp:"あなた"},{english:"your",jp:"あなたの"},{english:"you",jp:"あなたを／に"},{english:"yours",jp:"あなたのもの"}],[{english:"it",jp:"それ"},{english:"its",jp:"それの"},{english:"it",jp:"それを／に"},{english:"X",jp:"—"}],[{english:"Mao",jp:"マオ"},{english:"Mao’s",jp:"マオの"},{english:"Mao",jp:"マオ"},{english:"Mao’s",jp:"マオの"}],[{english:"Ken",jp:"ケン"},{english:"Ken’s",jp:"ケンの"},{english:"Ken",jp:"ケン"},{english:"Ken’s",jp:"ケンの"}]],[[{english:"he",jp:"かれ"},{english:"his",jp:"かれの"},{english:"him",jp:"かれを／に"},{english:"his",jp:"かれのもの"}],[{english:"she",jp:"かのじょ"},{english:"her",jp:"かのじょの"},{english:"her",jp:"かのじょを／に"},{english:"hers",jp:"かのじょのもの"}],[{english:"we",jp:"わたしたち"},{english:"our",jp:"わたしたちの"},{english:"us",jp:"わたしたちを／に"},{english:"ours",jp:"わたしたちのもの"}],[{english:"you",jp:"あなた(たち)"},{english:"your",jp:"あなた(たち)の"},{english:"you",jp:"あなた(たち)を／に"},{english:"yours",jp:"あなた(たち)のもの"}],[{english:"they",jp:"かれら／かのじょら"},{english:"their",jp:"かれらの"},{english:"them",jp:"かれらを／に"},{english:"theirs",jp:"かれらのもの"}]]]}},b=o(0),I=o(0),V=o(0),d=o(-1),T=o([]),g=o(0),ae=C(()=>ne[E.value].games.length),we=C(()=>ae.value*5),je=C(()=>b.value*5+I.value+1),k=o(!1),N=o(!1),J=o(fe),xe=C(()=>{const n=Math.round(J.value*1e3/de);return Math.max(80,Math.round(n/Y*Pt))}),y=o(!1),R=o(!0),w=o(!1),B=o(!1);function Se(n){const e=Math.PI*2*n/8,a=Math.cos(e),l=Math.sin(e),x=130,p=120,f=(n%2===0?1:-1)*(18+n*2);return{"--dx":`${(a*x).toFixed(1)}vw`,"--dy":`${(l*p).toFixed(1)}vh`,"--rot":`${f}deg`,"--sc":`${1.03}`,animationDuration:`${_e}ms`}}let W=null,c=null,m=null,O=null,P=0,X=null,z=null,A=null;const se=C(()=>!!ne[E.value]?.games?.length);function Me(n){E.value=n}function Te(){L.value=!L.value}function ke(){$.value=!$.value}function Be(){try{be.back()}catch{}}function j(n){return new Promise(e=>{if(!n)return e();const a=new Image;a.decoding="async",a.loading="eager",a.onload=()=>e(),a.onerror=()=>e(),a.src=n})}async function ve(){if(W)return W;const n=window.AudioContext||window.webkitAudioContext;return W=new n,W}async function Ce(n){const e=await ve(),l=await(await fetch(n,{cache:"force-cache"})).arrayBuffer();return await e.decodeAudioData(l)}function Ee(n,e,a){return ne[n].games[e][a]}function Ie(n){return[...n,...n].map((a,l)=>({...a,_slotKey:`${Date.now()}-${Math.random().toString(16).slice(2)}-${l}`}))}function he(n,e,a){const l=Ee(n,e,a);T.value=Ie(l)}function Ne(n){if(n<8){d.value=-1;return}const e=n-8;d.value=e>=0&&e<8?e:-1}function F(){z!=null&&(window.clearTimeout(z),z=null),A!=null&&(window.clearTimeout(A),A=null),X!=null&&(window.clearTimeout(X),X=null)}function oe(n=!0){I.value=0,V.value=0,d.value=-1,g.value=0,y.value=!1,R.value=!0,w.value=!1,B.value=!1,k.value=!1,N.value=!1,n&&(b.value=0)}function D(){try{m&&m.stop()}catch{}m=null,O=null,P=0}function Re(){F(),D(),oe(!0),T.value=[],r.value="idle",q.value="menu"}function Oe(){F(),D(),oe(!0),T.value=[],r.value="idle",q.value="menu"}function H(){B.value||k.value||N.value||(r.value="finished",d.value=-1,y.value=!1,B.value=!0,window.setTimeout(()=>{B.value=!1,T.value=[];const n=b.value<ae.value-1;k.value=n,N.value=!n},_e+40))}function ge(){F(),H()}function me(n,e){const a=xe.value,l=ce+de*Y,x=()=>{if(r.value!=="countdown"&&r.value!=="playing")return;const f=performance.now()-P,s=Math.max(0,Math.floor(f/a));if(s>=l){H();return}if(y.value=s%2===1,s<ce)return R.value=!0,w.value=!1,g.value=0,d.value=-1,s<2?M.value=3:s<4?M.value=2:s<6?M.value=1:(M.value=0,r.value="playing"),V.value=0,p(s+1,a);R.value=!1,r.value="playing";const v=s-ce,G=Math.floor(v/Y),h=v%Y;return I.value=Pe(G,0,de-1),V.value=h,h===0&&(he(n,e,I.value),d.value=-1,g.value=0),I.value===0&&h<8?(w.value=!0,g.value=h+1,d.value=-1):(w.value=!1,g.value=8,Ne(h)),p(s+1,a)};function p(f,s){const v=P+f*s,G=Math.max(0,v-performance.now());z=window.setTimeout(x,G)}he(n,e,0),g.value=0,d.value=-1,R.value=!0,w.value=!1,x()}function Pe(n,e,a){return Math.max(e,Math.min(a,n))}async function Ae(){b.value=0,await pe()}async function Fe(){b.value>=ae.value-1||(F(),D(),b.value+=1,k.value=!1,N.value=!1,await pe())}async function pe(){if(!se.value)return;r.value="loading",q.value="game",oe(!1),T.value=[],K.value=0;const n=E.value,e=b.value,a=[ue,Q,Z,ee,te,re].filter(Boolean),l=Array.from(new Set(a)),x=l.length+1;let p=0;const f=()=>{p+=1,K.value=Math.min(1,p/x)};await Promise.all(l.map(async Ge=>{await j(Ge),f()}));try{c=await Ce(Ye)}catch{c=null}f(),c?.duration&&Number.isFinite(c.duration)&&c.duration>1?J.value=c.duration:J.value=fe,r.value="countdown",M.value=3;const s=await ve();if(s.state==="suspended"&&await s.resume().catch(()=>{}),D(),!c){P=performance.now()+90,me(n,e),A=window.setTimeout(()=>H(),Math.round(J.value*1e3)+900);return}m=s.createBufferSource(),m.buffer=c,O=s.createGain(),O.gain.value=1,m.connect(O),O.connect(s.destination);const v=120,G=(s.baseLatency??0)+(s.outputLatency??0),h=Math.max(0,Math.round(G*1e3)),De=s.currentTime+v/1e3;m.start(De),P=performance.now()+v+h,m.onended=()=>ge(),X=window.setTimeout(()=>ge(),Math.round(c.duration*1e3)+v+h+120),me(n,e),A=window.setTimeout(()=>{(r.value==="countdown"||r.value==="playing")&&H()},Math.round(c.duration*1e3)+v+h+1200)}return qe(()=>{j(ue),j(Q),j(Z),j(ee),j(te),j(re)}),Le(()=>{F(),D()}),(n,e)=>(u(),i("section",{class:"otb-page",style:ie(ye.value),"aria-label":"On The Beat — Pronouns"},[e[7]||(e[7]=t("div",{class:"otb-bg","aria-hidden":"true"},null,-1)),e[8]||(e[8]=t("div",{class:"otb-bg-overlay","aria-hidden":"true"},null,-1)),t("button",{class:"home-btn",type:"button",onClick:Be,"aria-label":"Back"},[t("img",{src:U(re),alt:""},null,8,Ze)]),t("img",{class:_(["corner-icon tl corner-icon--mega",{"is-beating":y.value}]),src:U(Q),alt:"","aria-hidden":"true"},null,10,et),t("img",{class:_(["corner-icon tr",{"is-beating":y.value}]),src:U(Z),alt:"","aria-hidden":"true"},null,10,tt),t("img",{class:_(["corner-icon bl",{"is-beating":y.value}]),src:U(ee),alt:"","aria-hidden":"true"},null,10,nt),t("img",{class:_(["corner-icon br",{"is-beating":y.value}]),src:U(te),alt:"","aria-hidden":"true"},null,10,at),q.value==="menu"?(u(),i("section",st,[e[3]||(e[3]=$e('<header class="menu-head" data-v-cd14ceeb><div class="title-stack" aria-label="Game title" data-v-cd14ceeb><div class="title-main" data-v-cd14ceeb>Say the word</div><div class="title-sub" data-v-cd14ceeb>on the beat!</div></div><p class="menu-subtitle" data-v-cd14ceeb>A rhythm game</p></header>',1)),t("div",ot,[t("div",lt,[e[1]||(e[1]=t("div",{class:"menu-card__title"},"Set",-1)),t("div",it,[t("button",{class:_(["sq-btn",{"is-active":E.value==="pronouns"}]),type:"button",onClick:e[0]||(e[0]=a=>Me("pronouns"))}," Pronouns ",2)])]),t("div",ut,[e[2]||(e[2]=t("div",{class:"menu-card__title"},"Card Text",-1)),t("div",rt,[t("button",{class:_(["sq-btn",{"is-active":$.value}]),type:"button",onClick:ke}," Japanese ",2),t("button",{class:_(["sq-btn",{"is-active":L.value}]),type:"button",onClick:Te}," English ",2)])])]),t("div",ct,[t("button",{class:"sq-btn sq-btn--primary",type:"button",disabled:!se.value,onClick:Ae}," Play ",8,dt),se.value?le("",!0):(u(),i("div",vt,"This set is unavailable."))])])):(u(),i("section",ht,[t("header",gt,[t("div",mt,[t("div",pt,"Round "+S(je.value)+" / "+S(we.value),1)]),t("div",ft,[t("div",_t,"Beat "+S(V.value+1)+" / 16",1)]),t("div",{class:"hud-right"},[t("button",{class:"sq-btn",type:"button",onClick:Re},"Stop")])]),t("div",bt,[k.value||N.value?(u(),i("div",yt,[k.value?(u(),i("button",{key:0,class:"sq-btn sq-btn--primary",type:"button",onClick:Fe}," Continue ")):(u(),i("button",{key:1,class:"sq-btn sq-btn--primary",type:"button",onClick:Oe}," Finish "))])):(u(),i("div",wt,[(u(!0),i(Ke,null,Ve(T.value,(a,l)=>(u(),i("article",{key:a._slotKey,class:_(["beat-card no-image",[R.value?"deal-hidden":"",w.value&&l<g.value?"deal-in":"",w.value&&l>=g.value?"deal-hidden":"",B.value?"explode-out":"",d.value===l?"is-highlighted":""]]),role:"gridcell",style:ie(B.value?Se(l):void 0)},[t("div",jt,[$.value?(u(),i("div",xt,S(a.jp),1)):le("",!0),L.value?(u(),i("div",St,[t("div",Mt,S(a.english),1)])):(u(),i("div",Tt))])],6))),128))]))]),r.value==="loading"?(u(),i("div",kt,[t("div",Bt,[e[4]||(e[4]=t("div",{class:"overlay-title"},"Loading…",-1)),e[5]||(e[5]=t("div",{class:"overlay-sub"},"Preparing audio.",-1)),t("div",Ct,[t("div",Et,[t("div",{class:"bar__fill",style:ie({width:`${Math.round(K.value*100)}%`})},null,4)]),t("div",It,S(Math.round(K.value*100))+"%",1)])])])):r.value==="countdown"?(u(),i("div",Nt,[t("div",Rt,[t("div",Ot,S(M.value),1),e[6]||(e[6]=t("div",{class:"countdown-sub"},"Get ready",-1))])])):le("",!0)]))],4))}}),$t=We(At,[["__scopeId","data-v-cd14ceeb"]]);export{$t as default};
