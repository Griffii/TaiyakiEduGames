import{i as De,l as Ie,r,c as v,j as Ue,J as Fe,a as u,d as t,C as K,h as p,k as ze,G as b,t as o,F as ue,e as ve,P as Oe,g as Re,H as pe,K as qe,s as y,L as Ve,b as d,_ as Ke}from"./index-CRwM6Ms3.js";const He={class:"admin-panel chalkboard-bg"},We={class:"inner"},je={class:"head"},Ge={class:"left"},Je={class:"title"},Qe={class:"stats"},Xe={class:"stat-card"},Ye={class:"value"},Ze={class:"stat-card"},et={class:"value"},tt={key:0,class:"error"},st={key:1,class:"loading"},at={key:2,class:"table-section"},lt={class:"table-header"},nt={class:"pager"},ot={class:"page-size"},it=["value"],rt={class:"page-buttons"},dt=["disabled"],ct={class:"page-indicator"},ut=["disabled"],vt={class:"table-wrap",role:"region","aria-labelledby":"teachers-table"},pt={id:"teachers-table",class:"users-table"},mt={class:"col-name"},_t=["data-active","data-dir"],gt={class:"col-email"},bt=["data-active","data-dir"],ht={class:"col-login"},ft=["data-active","data-dir"],yt={key:0},wt={class:"col-avatar"},Ct=["onClick","title"],kt=["src"],St={class:"col-name"},Nt={class:"name-stack"},$t={class:"name"},Et={key:0,class:"chip chip-admin"},Mt={class:"col-email"},At={class:"email"},Lt={class:"col-login"},Pt={class:"login"},Tt={class:"col-actions"},xt=["disabled","onClick"],Bt={key:3,class:"table-section"},Dt={class:"table-header"},It={class:"pager"},Ut={class:"page-size"},Ft=["value"],zt={class:"page-buttons"},Ot=["disabled"],Rt={class:"page-indicator"},qt=["disabled"],Vt={class:"table-wrap",role:"region","aria-labelledby":"students-table"},Kt={id:"students-table",class:"users-table"},Ht={class:"col-name"},Wt=["data-active","data-dir"],jt={class:"col-email"},Gt=["data-active","data-dir"],Jt={class:"col-level center"},Qt=["data-active","data-dir"],Xt={class:"col-login"},Yt=["data-active","data-dir"],Zt={key:0},es={class:"col-avatar"},ts=["onClick","title"],ss=["src"],as={class:"col-name"},ls={class:"name"},ns={class:"col-email"},os={class:"email"},is={class:"col-level center"},rs={class:"levels"},ds=["title"],cs={class:"level-sub"},us=["title"],vs=["title"],ps=["title"],ms={class:"col-login"},_s={class:"login"},gs={class:"col-actions"},bs=["disabled","onClick"],hs={class:"code-sheet"},fs={class:"code-box"},ys={key:0,class:"theme-loading-overlay",role:"status","aria-live":"polite","aria-label":"Applying theme"},ws=De({__name:"AdminPanel",setup(Cs){const D=Ie(),S=r(!1),$=r(null),me=v(()=>D.orgName??""),w=v(()=>D.orgId??null),C=r([]),k=r("display_name"),h=r("asc"),f=r("display_name"),g=r("asc"),E=r(10),M=r(10),m=r(1),_=r(1),A=r(!1),I=r(null);function H(a){I.value=a,A.value=!0}function _e(){A.value=!1}function ge(a){let e=a?.avatar_url?.trim()||"";return e?/^https?:\/\//i.test(e)?e:(e=e.replace(/^\/+/,"").replace(/\/{2,}/g,"/"),e.startsWith("avatars/")||(e=`avatars/${e}`),y.storage.from("public-assets").getPublicUrl(e).data.publicUrl||null):null}function W(a){const e=a.target;e.onerror=null,e.style.visibility="hidden"}function j(a){if(!a)return"—";const e=new Date(a);if(Number.isNaN(e.getTime()))return"—";const s=e.toLocaleString(void 0,{month:"short"}),l=e.getDate(),i=String(e.getHours()).padStart(2,"0"),c=String(e.getMinutes()).padStart(2,"0");return`${s} ${l} @ ${i}:${c}`}async function be(){if(w.value){S.value=!0,$.value=null;try{const{data:a,error:e}=await y.from("org_memberships").select("org_id,user_id,role").eq("org_id",w.value);if(e)throw e;const s=a??[];if(!s.length){C.value=[];return}const l=new Map;for(const n of s)l.has(n.user_id)||l.set(n.user_id,new Set),l.get(n.user_id).add(n.role);const i=Array.from(l.keys()),{data:c,error:ne}=await y.from("profiles").select("id,display_name,email,last_seen").in("id",i);if(ne)throw ne;const oe=new Map;for(const n of c??[])oe.set(n.id,n);const{data:Le,error:ie}=await y.from("public_profiles").select("id,avatar_url").in("id",i);if(ie)throw ie;const re=new Map;for(const n of Le??[])re.set(n.id,n);const{data:Pe,error:de}=await y.from("v_profile_progress").select("user_id,level,reading_level,writing_level,listening_level").in("user_id",i);de&&console.warn("v_profile_progress fetch failed:",de);const ce=new Map;for(const n of Pe??[])ce.set(n.user_id,n);const Te=i.map(n=>{const xe=Array.from(l.get(n)??[]),V=oe.get(n),Be=re.get(n),B=ce.get(n);return{id:n,roles:xe,display_name:V?.display_name??"(No name)",email:V?.email??"",avatar_url:ge(Be),level:B?.level??null,reading_level:B?.reading_level??null,writing_level:B?.writing_level??null,listening_level:B?.listening_level??null,last_seen:V?.last_seen??null}});C.value=Te,m.value=1,_.value=1}catch(a){$.value=a?.message??"Failed to load members"}finally{S.value=!1}}}const G=v(()=>C.value.filter(a=>a.roles.includes("teacher")||a.roles.includes("admin"))),J=v(()=>C.value.filter(a=>a.roles.includes("student"))),he=v(()=>G.value.length),fe=v(()=>J.value.length);function L(a,e){const s=(a??"").toLowerCase(),l=(e??"").toLowerCase();return s<l?-1:s>l?1:0}function ye(a,e){const s=Number.isFinite(a)?a:-1/0,l=Number.isFinite(e)?e:-1/0;return s-l}function Q(a,e){const s=a?Date.parse(a):-1/0,l=e?Date.parse(e):-1/0;return s-l}const X=v(()=>{const a=k.value,e=h.value,s=[...G.value];return s.sort((l,i)=>{let c=0;return a==="display_name"?c=L(l.display_name,i.display_name):a==="email"?c=L(l.email,i.email):a==="last_seen"&&(c=Q(l.last_seen??null,i.last_seen??null)),e==="asc"?c:-c}),s}),Y=v(()=>{const a=f.value,e=g.value,s=[...J.value];return s.sort((l,i)=>{let c=0;return a==="display_name"?c=L(l.display_name,i.display_name):a==="email"?c=L(l.email,i.email):a==="level"?c=ye(l.level??null,i.level??null):a==="last_seen"&&(c=Q(l.last_seen??null,i.last_seen??null)),e==="asc"?c:-c}),s});function U(a){k.value===a?h.value=h.value==="asc"?"desc":"asc":(k.value=a,h.value=a==="display_name"?"asc":"desc")}function P(a){f.value===a?g.value=g.value==="asc"?"desc":"asc":(f.value=a,g.value=a==="level"||a==="last_seen"?"desc":"asc")}function Z(a,e,s){const l=(e-1)*s;return a.slice(l,l+s)}const ee=v(()=>Z(X.value,m.value,E.value)),te=v(()=>Z(Y.value,_.value,M.value)),F=v(()=>Math.max(1,Math.ceil(X.value.length/E.value))),z=v(()=>Math.max(1,Math.ceil(Y.value.length/M.value)));function we(a){E.value=a,m.value=1}function Ce(a){M.value=a,_.value=1}function ke(a){const e=Number(a.target.value);we(e)}function Se(a){const e=Number(a.target.value);Ce(e)}function se(a){m.value=Math.min(Math.max(1,a),F.value)}function ae(a){_.value=Math.min(Math.max(1,a),z.value)}async function le(a){if(!(!w.value||!window.confirm(`Remove ${a.display_name||"this user"} from this org?`))){a._pending=!0;try{const{error:s}=await y.from("org_memberships").delete().eq("org_id",w.value).eq("user_id",a.id);if(s)throw s;C.value=C.value.filter(l=>l.id!==a.id)}catch(s){alert(s?.message??"Failed to remove user from org")}finally{a._pending=!1}}}const T=r(!1),N=r("");async function Ne(){if(T.value=!0,await Ve(),!w.value){N.value="No Code Set";return}const{data:a,error:e,status:s}=await y.from("orgs").select("org_code").eq("id",w.value).limit(1);if(e){N.value=s===401||s===403?"Not allowed":"No Code Set";return}const l=Array.isArray(a)?a[0]:null,i=Number(l?.org_code);N.value=Number.isFinite(i)?i.toString().padStart(6,"0"):"No Code Set"}async function $e(){try{await navigator.clipboard.writeText(String(N.value??""))}catch{}}const x=r(!1);function Ee(){x.value=!0}function Me(){x.value=!1}const O=r(!1);function R(){O.value=!0,document.documentElement.classList.add("theme-loading")}function q(){O.value=!1,document.documentElement.classList.remove("theme-loading")}function Ae(){alert("Subscription portal coming soon!")}return Ue(async()=>{window.addEventListener("eitake:theme:begin",R),window.addEventListener("eitake:theme:end",q),await D.ensureIdentityLoaded(),await be()}),Fe(()=>{window.removeEventListener("eitake:theme:begin",R),window.removeEventListener("eitake:theme:end",q)}),(a,e)=>(d(),u("section",He,[t("div",We,[t("header",je,[t("div",Ge,[t("h1",Je,[b(o(me.value)+" ",1),e[15]||(e[15]=t("small",{class:"subtitle"},"Admin Panel",-1))]),e[16]||(e[16]=t("p",{class:"hint"},"Manage people, themes, and your subscription.",-1))]),t("div",Qe,[t("div",Xe,[e[17]||(e[17]=t("div",{class:"label"},"Teachers",-1)),t("div",Ye,o(he.value),1)]),t("div",Ze,[e[18]||(e[18]=t("div",{class:"label"},"Students",-1)),t("div",et,o(fe.value),1)])])]),t("div",{class:"actions"},[t("button",{class:"btn theme",type:"button",onClick:Ee},"Theme Editor"),t("button",{class:"btn subscription",type:"button",onClick:Ae},"Subscription"),t("button",{class:"btn school-code",type:"button",onClick:Ne},"School Code")]),$.value?(d(),u("div",tt,o($.value),1)):p("",!0),S.value?(d(),u("div",st,"Loading members…")):p("",!0),S.value?p("",!0):(d(),u("section",at,[t("div",lt,[e[21]||(e[21]=t("h2",{class:"table-title"},"Teachers",-1)),t("div",nt,[t("label",ot,[e[20]||(e[20]=t("span",{class:"rows-label"},"Rows:",-1)),t("select",{value:E.value,onChange:ke},[...e[19]||(e[19]=[t("option",{value:10},"10",-1),t("option",{value:25},"25",-1),t("option",{value:50},"50",-1),t("option",{value:100},"100",-1)])],40,it)]),t("div",rt,[t("button",{class:"mini-btn arrow",disabled:m.value<=1,onClick:e[0]||(e[0]=s=>se(m.value-1)),"aria-label":"Previous page"},"◀",8,dt),t("span",ct,o(m.value)+" / "+o(F.value),1),t("button",{class:"mini-btn arrow",disabled:m.value>=F.value,onClick:e[1]||(e[1]=s=>se(m.value+1)),"aria-label":"Next page"},"▶",8,ut)])])]),t("div",vt,[t("table",pt,[t("thead",null,[t("tr",null,[e[25]||(e[25]=t("th",{class:"col-avatar"},"Avatar",-1)),t("th",mt,[t("button",{class:"th-btn",type:"button",onClick:e[2]||(e[2]=s=>U("display_name"))},[e[22]||(e[22]=b(" Name ",-1)),t("span",{class:"sort","data-active":k.value==="display_name","data-dir":h.value},null,8,_t)])]),t("th",gt,[t("button",{class:"th-btn",type:"button",onClick:e[3]||(e[3]=s=>U("email"))},[e[23]||(e[23]=b(" E-mail ",-1)),t("span",{class:"sort","data-active":k.value==="email","data-dir":h.value},null,8,bt)])]),e[26]||(e[26]=t("th",{class:"col-level"},null,-1)),t("th",ht,[t("button",{class:"th-btn",type:"button",onClick:e[4]||(e[4]=s=>U("last_seen"))},[e[24]||(e[24]=b(" Last logged in ",-1)),t("span",{class:"sort","data-active":k.value==="last_seen","data-dir":h.value},null,8,ft)])]),e[27]||(e[27]=t("th",{class:"col-actions"},"Actions",-1))])]),t("tbody",null,[ee.value.length===0?(d(),u("tr",yt,[...e[28]||(e[28]=[t("td",{colspan:"6",class:"empty"},"No teachers yet.",-1)])])):p("",!0),(d(!0),u(ue,null,ve(ee.value,s=>(d(),u("tr",{key:s.id},[t("td",wt,[t("button",{class:"avatar-btn",type:"button",onClick:l=>H(s.id),title:`Open ${s.display_name} profile`},[t("img",{class:"avatar",src:s.avatar_url||"",alt:"",onError:W},null,40,kt)],8,Ct)]),t("td",St,[t("div",Nt,[t("span",$t,o(s.display_name),1),s.roles.includes("admin")?(d(),u("span",Et,"Admin")):p("",!0)])]),t("td",Mt,[t("span",At,o(s.email),1)]),e[29]||(e[29]=t("td",{class:"col-level"},null,-1)),t("td",Lt,[t("span",Pt,o(j(s.last_seen)),1)]),t("td",Tt,[t("button",{class:"mini-btn danger",type:"button",disabled:s._pending,onClick:l=>le(s)}," Remove from org ",8,xt)])]))),128))])])])])),S.value?p("",!0):(d(),u("section",Bt,[t("div",Dt,[e[32]||(e[32]=t("h2",{class:"table-title"},"Students",-1)),t("div",It,[t("label",Ut,[e[31]||(e[31]=t("span",{class:"rows-label"},"Rows:",-1)),t("select",{value:M.value,onChange:Se},[...e[30]||(e[30]=[t("option",{value:10},"10",-1),t("option",{value:25},"25",-1),t("option",{value:50},"50",-1),t("option",{value:100},"100",-1)])],40,Ft)]),t("div",zt,[t("button",{class:"mini-btn arrow",disabled:_.value<=1,onClick:e[5]||(e[5]=s=>ae(_.value-1)),"aria-label":"Previous page"},"◀",8,Ot),t("span",Rt,o(_.value)+" / "+o(z.value),1),t("button",{class:"mini-btn arrow",disabled:_.value>=z.value,onClick:e[6]||(e[6]=s=>ae(_.value+1)),"aria-label":"Next page"},"▶",8,qt)])])]),t("div",Vt,[t("table",Kt,[t("thead",null,[t("tr",null,[e[37]||(e[37]=t("th",{class:"col-avatar"},"Avatar",-1)),t("th",Ht,[t("button",{class:"th-btn",type:"button",onClick:e[7]||(e[7]=s=>P("display_name"))},[e[33]||(e[33]=b(" Name ",-1)),t("span",{class:"sort","data-active":f.value==="display_name","data-dir":g.value},null,8,Wt)])]),t("th",jt,[t("button",{class:"th-btn",type:"button",onClick:e[8]||(e[8]=s=>P("email"))},[e[34]||(e[34]=b(" E-mail ",-1)),t("span",{class:"sort","data-active":f.value==="email","data-dir":g.value},null,8,Gt)])]),t("th",Jt,[t("button",{class:"th-btn center",type:"button",onClick:e[9]||(e[9]=s=>P("level"))},[e[35]||(e[35]=b(" Levels ",-1)),t("span",{class:"sort","data-active":f.value==="level","data-dir":g.value},null,8,Qt)])]),t("th",Xt,[t("button",{class:"th-btn",type:"button",onClick:e[10]||(e[10]=s=>P("last_seen"))},[e[36]||(e[36]=b(" Last logged in ",-1)),t("span",{class:"sort","data-active":f.value==="last_seen","data-dir":g.value},null,8,Yt)])]),e[38]||(e[38]=t("th",{class:"col-actions"},"Actions",-1))])]),t("tbody",null,[te.value.length===0?(d(),u("tr",Zt,[...e[39]||(e[39]=[t("td",{colspan:"6",class:"empty"},"No students yet.",-1)])])):p("",!0),(d(!0),u(ue,null,ve(te.value,s=>(d(),u("tr",{key:s.id},[t("td",es,[t("button",{class:"avatar-btn",type:"button",onClick:l=>H(s.id),title:`Open ${s.display_name} profile`},[t("img",{class:"avatar",src:s.avatar_url||"",alt:"",onError:W},null,40,ss)],8,ts)]),t("td",as,[t("span",ls,o(s.display_name),1)]),t("td",ns,[t("span",os,o(s.email),1)]),t("td",is,[t("div",rs,[t("span",{class:"level-main",title:`Level ${s.level??1}`},o(s.level??1),9,ds),t("div",cs,[t("span",{class:"dot dot-reading",title:`Reading ${s.reading_level??"—"}`},o(s.reading_level??"—"),9,us),t("span",{class:"dot dot-writing",title:`Writing ${s.writing_level??"—"}`},o(s.writing_level??"—"),9,vs),t("span",{class:"dot dot-listening",title:`Listening ${s.listening_level??"—"}`},o(s.listening_level??"—"),9,ps)])])]),t("td",ms,[t("span",_s,o(j(s.last_seen)),1)]),t("td",gs,[t("button",{class:"mini-btn danger",type:"button",disabled:s._pending,onClick:l=>le(s)}," Remove from org ",8,bs)])]))),128))])])])]))]),I.value?(d(),K(Oe,{key:0,open:A.value,"onUpdate:open":e[11]||(e[11]=s=>A.value=s),"user-id":I.value,dev:!1,onClose:_e},null,8,["open","user-id"])):p("",!0),(d(),K(pe,{to:"body"},[T.value?(d(),u("div",{key:0,class:"code-modal",role:"dialog","aria-modal":"true",onClick:e[13]||(e[13]=Re(s=>T.value=!1,["self"]))},[t("div",hs,[t("button",{class:"code-close","aria-label":"Close",onClick:e[12]||(e[12]=s=>T.value=!1)},"✕"),e[40]||(e[40]=t("h3",{class:"code-title"},"School Code",-1)),t("div",fs,o(N.value||"No Code Set"),1),t("div",{class:"code-actions"},[t("button",{class:"btn",onClick:$e},"Copy")])])])):p("",!0)])),(d(),K(pe,{to:"body"},[O.value?(d(),u("div",ys,[...e[41]||(e[41]=[t("div",{class:"spinner","aria-hidden":"true"},null,-1),t("div",{class:"loading-caption"},"Applying theme…",-1)])])):p("",!0)])),ze(qe,{open:x.value,"onUpdate:open":e[14]||(e[14]=s=>x.value=s),onClose:Me,onApplyingTheme:R,onApplied:q},null,8,["open"])]))}}),Ss=Ke(ws,[["__scopeId","data-v-49d73f78"]]);export{Ss as default};
