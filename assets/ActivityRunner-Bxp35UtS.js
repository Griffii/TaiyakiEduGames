import{i as N,r as u,c as i,m as C,j as E,w as M,o as O,a as l,d as n,t as y,h as U,E as D,F as G,e as V,s as _,b as r,_ as T}from"./index-BiuPMolj.js";const j={class:"page activity-runner"},H={class:"head title-head"},Q={class:"title"},J={class:"content runner-content"},K=["src"],P={key:1,class:"empty"},X={class:"muted"},Y={key:0,class:"tags"},Z={class:"chips"},ee=N({__name:"ActivityRunner",setup(te){const o=C(),m=u(null),w=u(null),c=i(()=>o.params.slug),k=i(()=>o.params.id),S=/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i,d=(o.meta??{}).activity??void 0,s=u(null),p=u(!1),v=u(null);async function b(){if(v.value=null,s.value=null,!_)return;const t=k.value||c.value||d?.slug;if(t){p.value=!0;try{let e;if(S.test(t)?e=await _.from("activities").select("id,slug,name,type,url_path,external_url,icon_url,thumbnail_url,tags,launch_params,status,archived_at").eq("id",t).maybeSingle():e=await _.from("activities").select("id,slug,name,type,url_path,external_url,icon_url,thumbnail_url,tags,launch_params,status,archived_at").eq("slug",t).maybeSingle(),e.error)throw e.error;s.value=e.data??null,s.value||(v.value="Activity not found.")}catch(e){v.value=e?.message||"Failed to load activity."}finally{p.value=!1}}}E(b),M([c,k],()=>b());function R(){const t=o.query?.tags;return t?Array.isArray(t)?t.flatMap(e=>String(e).split(",")).map(e=>e.trim()).filter(Boolean):String(t).split(",").map(e=>e.trim()).filter(Boolean):[]}const q=i(()=>s.value?.name??d?.name??d?.title??(c.value?c.value.replace(/-/g," "):"Activity")),L=i(()=>(s.value?.tags??d?.tags??R()??[]).filter(Boolean));function F(t){if(!t)return"";let e=String(t).trim();if(!e)return"";if(/^[a-z][a-z0-9+\-.]*:\/\//i.test(e)||/^[a-z][a-z0-9+\-.]*:/i.test(e))return e;if(e.startsWith("//"))return(window.location?.protocol||"https:")+e;/^[\w.-]+\.[a-z]{2,}([/:?#]|$)/i.test(e)&&(e="https://"+e);try{const a=new URL(e,window.location.origin),I=a.pathname.split("/").pop()||"";return!/\.[a-z0-9]+$/i.test(I)&&!a.search&&!a.hash&&!a.pathname.endsWith("/")&&(a.pathname+="/"),a.toString()}catch{return e}}const g=i(()=>s.value?.slug||c.value||d?.slug||"activity"),B=i(()=>{const t=o.query.url;if(t)return t;const e="/TaiyakiEduGames/".replace(/\/+$/,""),a=g.value||"activity";return`${e}/godot_games/${a}/index.html`}),h=i(()=>F(B.value));function z(t){try{return new URL(t).origin}catch{return null}}const W=new Set([typeof window<"u"?window.location.origin:""]),f=i(()=>{const t=z(h.value);return t&&W.has(t)?t:null});function $(){if(!f.value)return;const t={version:"1.0.0",activity_id:s.value?.id||g.value,slug:s.value?.slug||g.value};m.value?.contentWindow?.postMessage({type:"parent:init",payload:t},f.value)}function x(t){if(!f.value||t.origin!==f.value)return;const{type:e,payload:a}=t.data||{};e==="request:fullscreen"&&A(),e==="xp:award"&&console.info("[ActivityRunner] xp:award",a),e==="track:event"&&console.info("[ActivityRunner] track:event",a)}function A(){const t=m.value||w.value||document.documentElement,e=t.requestFullscreen||t.webkitRequestFullscreen||t.msRequestFullscreen;e&&e.call(t)}return E(()=>window.addEventListener("message",x)),O(()=>window.removeEventListener("message",x)),(t,e)=>(r(),l("div",j,[n("header",H,[n("h1",Q,y(q.value),1)]),n("main",J,[n("div",{class:"frame-wrap",ref_key:"frameWrap",ref:w},[h.value?(r(),l("iframe",{key:0,ref_key:"frameEl",ref:m,src:h.value,title:"",allow:"fullscreen; autoplay; gamepad",allowfullscreen:"",sandbox:"allow-scripts allow-same-origin allow-pointer-lock allow-forms allow-popups",onLoad:$},null,40,K)):(r(),l("div",P,[n("p",X,y(p.value?"Loading activityâ€¦":v.value||"No external URL configured for this activity."),1)]))],512),n("div",{class:"under-actions"},[n("button",{class:"btn primary",onClick:A}," Go Fullscreen ")]),L.value.length?(r(),l("section",Y,[n("div",Z,[(r(!0),l(G,null,V(L.value,a=>(r(),l("span",{key:a,class:"chip"},"# "+y(a),1))),128))])])):U("",!0),e[0]||(e[0]=D('<section class="achievements" data-v-cd8ed71f><h2 class="section-title" data-v-cd8ed71f>Achievements</h2><div class="badges" data-v-cd8ed71f><div class="badge locked" data-v-cd8ed71f><div class="icon" aria-hidden="true" data-v-cd8ed71f>ğŸ†</div><div class="label" data-v-cd8ed71f>Locked</div></div><div class="badge locked" data-v-cd8ed71f><div class="icon" aria-hidden="true" data-v-cd8ed71f>â­</div><div class="label" data-v-cd8ed71f>Locked</div></div><div class="badge locked" data-v-cd8ed71f><div class="icon" aria-hidden="true" data-v-cd8ed71f>ğŸ¯</div><div class="label" data-v-cd8ed71f>Locked</div></div><div class="badge locked" data-v-cd8ed71f><div class="icon" aria-hidden="true" data-v-cd8ed71f>â±ï¸</div><div class="label" data-v-cd8ed71f>Locked</div></div></div><small class="muted note" data-v-cd8ed71f>Achievement tracking coming soon.</small></section>',1))])]))}}),ne=T(ee,[["__scopeId","data-v-cd8ed71f"]]);export{ne as default};
